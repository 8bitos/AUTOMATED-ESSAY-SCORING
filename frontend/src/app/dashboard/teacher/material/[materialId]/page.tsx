"use client";

import { useState, useEffect, useCallback, useRef, JSX } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import {
  FiArrowLeft,
  FiPlus,
  FiBookOpen,
  FiHelpCircle,
  FiLink,
  FiTrash2,
  FiEdit,
  FiMoreVertical,
  FiPlayCircle,
  FiAward,
  FiTag,
  FiChevronDown,
  FiChevronUp,
  FiFileText,
  FiX,
  FiUploadCloud,
  FiAlertCircle,
  FiUsers,
  FiSearch,
  FiAlignLeft,
  FiAlignCenter,
  FiAlignRight,
  FiAlignJustify,
  FiRotateCcw,
  FiRotateCw,
  FiImage,
  FiGrid,
  FiMinusSquare,
  FiPlusSquare,
  FiType,
  FiMaximize2,
  FiMinimize2,
} from 'react-icons/fi';
import ConfirmDialog from '@/components/ui/ConfirmDialog';
import NoticeDialog from '@/components/ui/NoticeDialog';
import LoadingDialog from '@/components/ui/LoadingDialog';

// --- INTERFACES ---
interface MaterialDetail {
  id: string;
  judul: string;
  material_type?: "materi" | "soal" | "tugas";
  isi_materi?: string;
  file_url?: string;
  class_id: string;
}

type MaterialBlockType = "heading" | "paragraph" | "video" | "image" | "link" | "pdf" | "ppt" | "bullet_list" | "number_list";
type BlockAlign = "left" | "center" | "right" | "justify";
type MediaSize = "small" | "medium" | "large" | "full";

interface MaterialContentBlock {
  id: string;
  type: MaterialBlockType;
  value: string;
  align?: BlockAlign;
  size?: MediaSize;
}

interface EditableDescriptor {
    score: string;
    description: string;
}

type RubricType = "analitik" | "holistik";

interface AutoGeneratedDescriptor {
  score: number;
  description: string;
}

interface AutoGeneratedRubricAspect {
  nama_aspek: string;
  descriptors: AutoGeneratedDescriptor[];
}

interface AutoGeneratedQuestion {
  teks_soal: string;
  keywords: string[];
  ideal_answer: string;
  weight?: number;
  rubric_type: RubricType;
  rubrics: AutoGeneratedRubricAspect[];
}

interface Rubric {
    id?: string;
    nama_aspek: string;
    deskripsi?: string;
    rubric_type?: RubricType;
    descriptors: {
      map(arg0: (d: any) => JSX.Element): import("react").ReactNode; [key: number]: string 
};
}

// Internal interface for form handling
interface EditableRubric extends Omit<Rubric, 'descriptors'> {
    descriptors: EditableDescriptor[];
}

interface EssayQuestion { 
    id: string; 
    material_id: string; 
    module_id?: string;
    teks_soal: string; 
    level_kognitif?: string;
    ideal_answer?: string;
    keywords?: string; // String for the form input, will be parsed to array for backend
    weight?: number;
    rubrics?: Rubric[]; // Reverted to plural to match backend
}

interface Student {
  id: string;
  student_name: string;
  student_email: string;
}

interface Submission {
  rubric_scores: any;
  id: string;
  question_id: string;
  student_id: string;
  teks_jawaban: string;
  submitted_at: string;
  skor_ai?: number; // Score from AI grading
  umpan_balik_ai?: string; // Feedback from AI grading
  revised_score?: number; // Teacher's revised score
  teacher_feedback?: string; // Teacher's feedback
  review_id?: string; // ID of the teacher review
  // Denormalized student info for display
  student_name?: string;
  student_email?: string;
}

interface RAGMaterialOption { id: string; judul: string; material_type?: "materi" | "soal" | "tugas"; }
interface QuestionBankEntry {
  id: string;
  class_id: string;
  class_name?: string;
  source_material_id?: string;
  material_title?: string;
  source_question_id?: string;
  teks_soal: string;
  level_kognitif?: string;
  keywords?: string[];
  ideal_answer?: string;
  weight?: number;
  rubrics?: any[];
  created_at?: string;
  updated_at?: string;
}

const formatDescriptor = (value: any) => {
  if (value == null) return "";
  if (typeof value === "string" || typeof value === "number") return String(value);
  if (typeof value === "object") {
    if (typeof value.description === "string") return value.description;
    if (typeof value.deskripsi === "string") return value.deskripsi;
    return JSON.stringify(value);
  }
  return String(value);
};

const createBlockId = () => `blk_${Math.random().toString(36).slice(2, 9)}`;

const parseMaterialBlocks = (raw?: string): MaterialContentBlock[] | null => {
  if (!raw) return null;
  try {
    const parsed = JSON.parse(raw);
    if (parsed?.format !== "sage_blocks" || !Array.isArray(parsed?.blocks)) return null;
    return parsed.blocks
      .map((b: any) => ({
        id: typeof b.id === "string" && b.id ? b.id : createBlockId(),
        type: b.type as MaterialBlockType,
        value: typeof b.value === "string" ? b.value : "",
        align: ["left", "center", "right", "justify"].includes(b.align) ? b.align : "left",
        size: ["small", "medium", "large", "full"].includes(b.size) ? b.size : "medium",
      }))
      .filter((b: MaterialContentBlock) => ["heading", "paragraph", "video", "image", "link", "pdf", "ppt", "bullet_list", "number_list"].includes(b.type));
  } catch {
    return null;
  }
};

const serializeMaterialBlocks = (blocks: MaterialContentBlock[]) =>
  JSON.stringify({
    format: "sage_blocks",
    version: 1,
    blocks: blocks.map((b) => ({ id: b.id, type: b.type, value: b.value, align: b.align ?? "left", size: b.size ?? "medium" })),
  });

const containsHtmlTag = (value?: string): boolean => /<([a-z][\w-]*)\b[^>]*>/i.test(value || "");

const escapeHtml = (value: string): string =>
  value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

const materialBlocksToRichHtml = (blocks: MaterialContentBlock[]): string => {
  const items = blocks
    .map((block) => {
      const align = block.align && block.align !== "left" ? ` style="text-align:${block.align};"` : "";
      if (block.type === "heading") {
        return `<h2${align}>${escapeHtml(block.value)}</h2>`;
      }
      if (block.type === "paragraph") {
        return `<p${align}>${escapeHtml(block.value).replace(/\n/g, "<br/>")}</p>`;
      }
      if (block.type === "bullet_list" || block.type === "number_list") {
        const rows = block.value
          .split("\n")
          .map((r) => r.trim())
          .filter(Boolean)
          .map((r) => `<li>${escapeHtml(r)}</li>`)
          .join("");
        if (!rows) return "";
        return block.type === "bullet_list" ? `<ul${align}>${rows}</ul>` : `<ol${align}>${rows}</ol>`;
      }
      if (["link", "pdf", "ppt", "video", "image"].includes(block.type) && block.value.trim()) {
        const safeUrl = escapeHtml(block.value.trim());
        return `<p${align}><a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeUrl}</a></p>`;
      }
      return "";
    })
    .filter(Boolean);

  if (items.length === 0) return "<p></p>";
  return items.join("\n");
};

const normalizeMaterialForRichEditor = (raw?: string, fileUrl?: string): string => {
  const blocks = parseMaterialBlocks(raw);
  if (blocks && blocks.length > 0) {
    return materialBlocksToRichHtml(blocks);
  }

  const trimmed = (raw || "").trim();
  if (trimmed) {
    if (containsHtmlTag(trimmed)) return trimmed;
    return `<p>${escapeHtml(trimmed).replace(/\n/g, "<br/>")}</p>`;
  }

  if (fileUrl?.trim()) {
    const safe = escapeHtml(fileUrl.trim());
    return `<p><a href="${safe}" target="_blank" rel="noopener noreferrer">${safe}</a></p>`;
  }

  return "<p></p>";
};

const sanitizeEditorHtml = (html: string): string => {
  const noScript = html
    .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "")
    .replace(/<style[\s\S]*?>[\s\S]*?<\/style>/gi, "")
    .replace(/[\u202A-\u202E\u2066-\u2069]/g, "")
    .trim();
  return noScript || "<p></p>";
};

const normalizeEditorNodeDirection = (root: HTMLDivElement): void => {
  root.setAttribute("dir", "ltr");
  root.style.direction = "ltr";
  root.style.unicodeBidi = "normal";
  root.style.writingMode = "horizontal-tb";
  root.style.textAlign = "left";

  root.querySelectorAll<HTMLElement>("[dir='rtl'], [dir='auto']").forEach((el) => {
    el.setAttribute("dir", "ltr");
  });

  root.querySelectorAll<HTMLElement>("[style*='direction'], [style*='unicode-bidi'], [style*='writing-mode']").forEach((el) => {
    const style = el.getAttribute("style") || "";
    const cleaned = style
      .replace(/direction\s*:\s*rtl\s*;?/gi, "")
      .replace(/unicode-bidi\s*:\s*(bidi-override|plaintext|isolate-override)\s*;?/gi, "")
      .replace(/writing-mode\s*:\s*[^;]+;?/gi, "")
      .trim();
    if (cleaned) {
      el.setAttribute("style", cleaned);
    } else {
      el.removeAttribute("style");
    }
  });
};

const normalizeEmbedUrl = (url: string): string => {
  const trimmed = (url || "").trim();
  if (!trimmed) return "";
  const ytMatch = trimmed.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&?/]+)/i);
  if (ytMatch?.[1]) return `https://www.youtube.com/embed/${ytMatch[1]}`;
  const ytShortsMatch = trimmed.match(/youtube\.com\/shorts\/([^&?/]+)/i);
  if (ytShortsMatch?.[1]) return `https://www.youtube.com/embed/${ytShortsMatch[1]}`;
  return trimmed;
};

const isImageLikeUrl = (url: string): boolean =>
  /\.(png|jpe?g|gif|webp|svg|bmp|avif)(\?.*)?$/i.test((url || "").trim());

const PdfBlockCard = ({ url }: { url: string }) => {
  const [showPreview, setShowPreview] = useState(false);
  return (
    <div className="border border-slate-200 rounded-xl p-3 bg-white space-y-3">
      <div className="flex items-center justify-between gap-3">
        <p className="text-sm font-medium text-slate-800">PDF Materi</p>
        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={() => setShowPreview((prev) => !prev)}
            className="sage-button-outline"
          >
            {showPreview ? "Tutup Preview" : "Preview"}
          </button>
          <a href={url} download className="sage-button-outline">
            Download
          </a>
        </div>
      </div>
      {showPreview && (
        <div className="rounded-lg overflow-hidden border border-slate-200 bg-slate-50">
          <iframe
            src={url}
            title="PDF Preview"
            className="w-full h-80"
          />
        </div>
      )}
    </div>
  );
};

const getTextAlignClass = (align?: BlockAlign) => {
  if (align === "center") return "text-center";
  if (align === "right") return "text-right";
  if (align === "justify") return "text-justify";
  return "text-left";
};

const getMediaWidthClass = (size?: MediaSize) => {
  if (size === "small") return "w-full md:w-1/3";
  if (size === "large") return "w-full md:w-5/6";
  if (size === "full") return "w-full";
  return "w-full md:w-2/3";
};

const MaterialContentRenderer = ({
  isiMateri,
  fileUrl,
}: {
  isiMateri?: string;
  fileUrl?: string;
}) => {
  const blocks = parseMaterialBlocks(isiMateri);

  if (blocks && blocks.length > 0) {
    return (
      <div className="space-y-4">
        {blocks.map((block) => {
          if (block.type === "heading") {
            return (
              <h3 key={block.id} className={`text-xl font-semibold text-slate-900 ${getTextAlignClass(block.align)}`}>
                {block.value}
              </h3>
            );
          }
          if (block.type === "paragraph") {
            return (
              <p key={block.id} className={`text-slate-700 whitespace-pre-line leading-relaxed ${getTextAlignClass(block.align)}`}>
                {block.value}
              </p>
            );
          }
          if (block.type === "bullet_list" || block.type === "number_list") {
            const items = block.value.split("\n").map((x) => x.trim()).filter(Boolean);
            if (items.length === 0) return null;
            return block.type === "bullet_list" ? (
              <ul key={block.id} className={`list-disc pl-6 text-slate-700 space-y-1 ${getTextAlignClass(block.align)}`}>
                {items.map((item, i) => <li key={`${block.id}-${i}`}>{item}</li>)}
              </ul>
            ) : (
              <ol key={block.id} className={`list-decimal pl-6 text-slate-700 space-y-1 ${getTextAlignClass(block.align)}`}>
                {items.map((item, i) => <li key={`${block.id}-${i}`}>{item}</li>)}
              </ol>
            );
          }
          if (block.type === "video") {
            const src = normalizeEmbedUrl(block.value);
            return src ? (
              <div key={block.id} className={`flex ${block.align === "right" ? "justify-end" : block.align === "center" ? "justify-center" : "justify-start"}`}>
                <div className={`${getMediaWidthClass(block.size)} rounded-xl overflow-hidden border border-slate-200 bg-black/5`}>
                  <iframe
                    src={src}
                    title="Video Materi"
                    className="w-full h-64"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerPolicy="strict-origin-when-cross-origin"
                    allowFullScreen
                  />
                </div>
              </div>
            ) : null;
          }
          if (block.type === "image") {
            return block.value ? (
              <div key={block.id} className={`flex ${block.align === "right" ? "justify-end" : block.align === "center" ? "justify-center" : "justify-start"}`}>
                <div className={`${getMediaWidthClass(block.size)} rounded-xl overflow-hidden border border-slate-200`}>
                  <img src={block.value} alt="Gambar Materi" className="w-full h-auto object-cover" />
                </div>
              </div>
            ) : null;
          }
          if (block.type === "link") {
            if (!block.value) return null;
            if (isImageLikeUrl(block.value)) {
              return (
                <div key={block.id} className={`flex ${block.align === "right" ? "justify-end" : block.align === "center" ? "justify-center" : "justify-start"}`}>
                  <div className={`${getMediaWidthClass(block.size)} rounded-xl overflow-hidden border border-slate-200`}>
                    <img src={block.value} alt="Gambar Materi" className="w-full h-auto object-cover" />
                  </div>
                </div>
              );
            }
            return (
              <a
                key={block.id}
                href={block.value}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 text-slate-800 font-medium underline"
              >
                <FiLink size={14} /> {block.value}
              </a>
            );
          }
          if (block.type === "pdf" || block.type === "ppt") {
            if (!block.value) return null;
            if (block.type === "pdf") {
              return <PdfBlockCard key={block.id} url={block.value} />;
            }
            return (
              <a
                key={block.id}
                href={block.value}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 text-slate-800 font-medium underline"
              >
                <FiFileText size={14} /> {block.type.toUpperCase()} Materi
              </a>
            );
          }
          return null;
        })}
        {fileUrl && (
          <a
            href={fileUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-2 text-slate-800 font-semibold hover:underline"
          >
            <FiLink />
            <span>Download/Lihat File Materi</span>
          </a>
        )}
      </div>
    );
  }

  if (isiMateri) {
    const html = containsHtmlTag(isiMateri)
      ? isiMateri
      : escapeHtml(isiMateri).replace(/\n/g, "<br />");
    return (
      <div
        className="prose max-w-none text-slate-700"
        dangerouslySetInnerHTML={{ __html: html }}
      />
    );
  }

  if (fileUrl) {
    return (
      <a
        href={fileUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="inline-flex items-center gap-2 text-slate-800 font-semibold hover:underline"
      >
        <FiLink />
        <span>Download/Lihat File Materi</span>
      </a>
    );
  }

  return <p className="text-slate-500">Tidak ada konten teks atau file untuk materi ini.</p>;
};

// Dummy Modal (reused from ClassDetailsPage)
const Modal = ({
  isOpen,
  onClose,
  title,
  children,
  panelClassName = "",
}: {
  isOpen: boolean,
  onClose: () => void,
  title: string,
  children: React.ReactNode,
  panelClassName?: string,
}) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4">
      <div className={`sage-panel p-6 w-full max-w-lg relative max-h-[90vh] overflow-y-auto ${panelClassName}`}>
        <button onClick={onClose} className="absolute top-4 right-4 text-[color:var(--ink-500)] hover:text-[color:var(--ink-900)]"><FiX size={24} /></button>
        <h2 className="text-xl font-bold text-[color:var(--ink-900)] mb-4">{title}</h2>
        {children}
      </div>
    </div>
  );
};

const QuestionBankPickerModal = ({
  isOpen,
  onClose,
  entries,
  loading,
  error,
  query,
  onQueryChange,
  onRefresh,
  onPick,
}: {
  isOpen: boolean;
  onClose: () => void;
  entries: QuestionBankEntry[];
  loading: boolean;
  error: string;
  query: string;
  onQueryChange: (value: string) => void;
  onRefresh: () => void;
  onPick: (entry: QuestionBankEntry) => void;
}) => {
  if (!isOpen) return null;
  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Pilih Soal dari Bank Soal" panelClassName="max-w-4xl h-[82vh] overflow-hidden">
      <div className="h-full flex flex-col gap-3">
        <div className="flex flex-col md:flex-row gap-2">
          <input
            value={query}
            onChange={(e) => onQueryChange(e.target.value)}
            placeholder="Cari soal / materi / kelas"
            className="sage-input flex-1"
          />
          <button type="button" onClick={onRefresh} className="sage-button-outline">Refresh</button>
        </div>
        {error && <p className="text-sm text-red-600">{error}</p>}
        <div className="flex-1 overflow-y-auto space-y-3 pr-1">
          {loading && <p className="text-sm text-slate-500">Memuat bank soal...</p>}
          {!loading && entries.length === 0 && (
            <div className="rounded-xl border border-dashed border-slate-300 p-5 text-sm text-slate-500">
              Belum ada soal di bank soal.
            </div>
          )}
          {entries.map((entry) => (
            <div key={entry.id} className="rounded-xl border border-slate-200 bg-white p-4 shadow-sm space-y-2">
              <p className="text-sm font-semibold text-slate-900 line-clamp-2">{entry.teks_soal}</p>
              <div className="flex flex-wrap gap-2 text-xs text-slate-600">
                <span className="sage-pill">Kelas: {entry.class_name || "-"}</span>
                <span className="sage-pill">Materi: {entry.material_title || "-"}</span>
                {entry.level_kognitif && <span className="sage-pill">Level: {entry.level_kognitif}</span>}
                {typeof entry.weight === "number" && <span className="sage-pill">Bobot: {entry.weight}</span>}
                <span className="sage-pill">Rubrik: {Array.isArray(entry.rubrics) ? entry.rubrics.length : 0}</span>
              </div>
              <div className="flex justify-end">
                <button type="button" className="sage-button" onClick={() => onPick(entry)}>
                  Gunakan Soal Ini
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </Modal>
  );
};

// --- ESSAY QUESTION FORM MODAL ---
const EssayQuestionFormModal = ({
  isOpen,
  onClose,
  materialId,
  ragMaterials,
  onFinished,
  existingQuestion,
}: {
  isOpen: boolean;
  onClose: () => void;
  materialId: string;
  ragMaterials: RAGMaterialOption[];
  onFinished: () => void;
  existingQuestion?: EssayQuestion | null;
}) => {
  const [teksSoal, setTeksSoal] = useState('');
  const [levelKognitif, setLevelKognitif] = useState('');
  const [idealAnswer, setIdealAnswer] = useState('');
  const [keywords, setKeywords] = useState('');
  const [weight, setWeight] = useState<string | number>('');
  const [selectedRAGMaterialId, setSelectedRAGMaterialId] = useState(materialId);
  const [rubricType, setRubricType] = useState<RubricType>('analitik');
  const [analyticRubrics, setAnalyticRubrics] = useState<EditableRubric[]>([
    { nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] },
  ]);
  const [holisticAspectName, setHolisticAspectName] = useState('Penilaian Holistik');
  const [holisticDescriptors, setHolisticDescriptors] = useState<EditableDescriptor[]>([{ score: '', description: '' }]);
  const [error, setError] = useState('');
  const [step, setStep] = useState(1);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [questionMode, setQuestionMode] = useState<'manual' | 'auto'>('manual');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSavingToBank, setIsSavingToBank] = useState(false);
  const [isBankPickerOpen, setIsBankPickerOpen] = useState(false);
  const [bankEntries, setBankEntries] = useState<QuestionBankEntry[]>([]);
  const [bankQuery, setBankQuery] = useState('');
  const [bankError, setBankError] = useState('');
  const [bankLoading, setBankLoading] = useState(false);
  const [bankNotice, setBankNotice] = useState('');
  const [lastSavedBankSignature, setLastSavedBankSignature] = useState<string>('');

  useEffect(() => {
    if (isOpen && existingQuestion) {
      setTeksSoal(existingQuestion.teks_soal);
      setLevelKognitif(existingQuestion.level_kognitif || '');
      setIdealAnswer(existingQuestion.ideal_answer || '');
      setKeywords(existingQuestion.keywords || '');
      setWeight(existingQuestion.weight ?? '');
      setSelectedRAGMaterialId(materialId);

      const rubricsArray = Array.isArray(existingQuestion.rubrics)
        ? existingQuestion.rubrics
        : [];
      const detectedType = (rubricsArray?.[0] as any)?.rubric_type;
      const fallbackType: RubricType = rubricsArray.length <= 1 ? 'holistik' : 'analitik';
      const normalizedRubrics = rubricsArray.map((r) => ({
        ...r,
        descriptors: Object.entries(r.descriptors || {}).map(
          ([score, description]) => ({
            score: String(score),
            description: formatDescriptor(description),
          })
        ),
      }));
      const resolvedType = detectedType === 'holistik' || detectedType === 'analitik' ? detectedType : fallbackType;
      setRubricType(resolvedType);

      if (resolvedType === 'analitik') {
        setAnalyticRubrics(
          normalizedRubrics.length
            ? normalizedRubrics.map((r) => ({
                ...r,
                rubric_type: 'analitik',
                nama_aspek: (r.nama_aspek || '').trim(),
                descriptors: r.descriptors.length ? r.descriptors : [{ score: '', description: '' }],
              }))
            : [{ nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] }]
        );
      } else {
        const first = normalizedRubrics[0];
        setHolisticAspectName((first?.nama_aspek || '').trim() || 'Penilaian Holistik');
        setHolisticDescriptors(first?.descriptors?.length ? first.descriptors : [{ score: '', description: '' }]);
      }
    }

    if (!isOpen) {
      setTeksSoal('');
      setLevelKognitif('');
      setIdealAnswer('');
      setKeywords('');
      setWeight('');
      setSelectedRAGMaterialId(materialId);
      setRubricType('analitik');
      setAnalyticRubrics([{ nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] }]);
      setHolisticAspectName('Penilaian Holistik');
      setHolisticDescriptors([{ score: '', description: '' }]);
      setError('');
      setStep(1);
      setShowAdvanced(false);
      setQuestionMode('manual');
      setIsGenerating(false);
      setIsSavingToBank(false);
      setIsBankPickerOpen(false);
      setBankEntries([]);
      setBankQuery('');
      setBankError('');
      setBankLoading(false);
      setBankNotice('');
      setLastSavedBankSignature('');
    }
  }, [isOpen, existingQuestion, materialId]);

  const handleRubricTypeChange = (nextType: RubricType) => setRubricType(nextType);

  const activeRubrics: EditableRubric[] =
    rubricType === 'analitik'
      ? analyticRubrics
      : [{ nama_aspek: holisticAspectName || 'Penilaian Holistik', rubric_type: 'holistik', descriptors: holisticDescriptors }];

  const validateStep = (targetStep: number) => {
    if (targetStep === 1) {
      if (!teksSoal.trim()) {
        setError('Teks soal tidak boleh kosong.');
        return false;
      }
    }
    if (targetStep === 2) {
      if (rubricType === 'analitik') {
        if (!analyticRubrics.length) {
          setError('Tambahkan minimal 1 aspek rubrik analitik.');
          return false;
        }
        for (const aspect of analyticRubrics) {
          if (!aspect.nama_aspek.trim()) {
            setError('Nama aspek rubrik analitik wajib diisi.');
            return false;
          }
          if (!aspect.descriptors.length) {
            setError(`Aspek "${aspect.nama_aspek}" harus punya minimal 1 skor.`);
            return false;
          }
          for (const d of aspect.descriptors) {
            if (d.score === '' || Number.isNaN(Number(d.score)) || !d.description.trim()) {
              setError(`Setiap skor pada aspek "${aspect.nama_aspek}" harus lengkap.`);
              return false;
            }
          }
        }
      } else {
        if (!holisticDescriptors.length) {
          setError('Tambahkan minimal 1 skor rubrik holistik.');
          return false;
        }
        for (const d of holisticDescriptors) {
          if (d.score === '' || Number.isNaN(Number(d.score)) || !d.description.trim()) {
            setError('Setiap skor rubrik holistik harus punya angka skor dan deskripsi.');
            return false;
          }
        }
      }
    }
    setError('');
    return true;
  };

  const goToStep = (nextStep: number) => {
    if (nextStep > step && !validateStep(step)) return;
    setStep(nextStep);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateStep(1) || !validateStep(2)) return;
    const url = existingQuestion
      ? `/api/essay-questions/${existingQuestion.id}`
      : '/api/essay-questions';

    const method = existingQuestion ? 'PUT' : 'POST';

    const parsedKeywords = keywords
      .split(',')
      .map((k) => k.trim())
      .filter(Boolean);

    const parsedWeight = weight === '' ? null : Number(weight);

    try {
      const transformedRubrics = activeRubrics.map((r) => {
        const descriptors: { [key: number]: string } = {};
        for (const d of r.descriptors) {
          const scoreNum = Number(d.score);
          if (isNaN(scoreNum)) {
            throw new Error(`Skor "${d.score}" tidak valid.`);
          }
          descriptors[scoreNum] = d.description;
        }
        return {
          id: r.id,
          nama_aspek: r.nama_aspek || (rubricType === 'holistik' ? 'Penilaian Holistik' : 'Kriteria'),
          deskripsi: r.deskripsi,
          rubric_type: rubricType,
          descriptors,
        };
      });

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          material_id: materialId,
          teks_soal: teksSoal,
          level_kognitif: levelKognitif || null,
          ideal_answer: idealAnswer || null,
          keywords: parsedKeywords.length ? parsedKeywords : null,
          weight: parsedWeight,
          rubrics: transformedRubrics,
        }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || 'Gagal menyimpan soal.');
      }

      await onFinished();
      onClose();
    } catch (err: any) {
      setError(err.message);
    }
  };

  const transformRubricsForSave = () =>
    activeRubrics.map((r) => {
      const descriptors: { [key: number]: string } = {};
      for (const d of r.descriptors) {
        const scoreNum = Number(d.score);
        if (isNaN(scoreNum)) continue;
        descriptors[scoreNum] = d.description;
      }
      return {
        id: r.id,
        nama_aspek: r.nama_aspek || (rubricType === 'holistik' ? 'Penilaian Holistik' : 'Kriteria'),
        deskripsi: r.deskripsi,
        rubric_type: rubricType,
        descriptors,
      };
    });

  const applyQuestionBankEntry = (entry: QuestionBankEntry) => {
    setTeksSoal(entry.teks_soal || '');
    setLevelKognitif(entry.level_kognitif || '');
    setIdealAnswer(entry.ideal_answer || '');
    setKeywords(Array.isArray(entry.keywords) ? entry.keywords.join(', ') : '');
    setWeight(typeof entry.weight === 'number' ? entry.weight : '');

    const rubricsArray = Array.isArray(entry.rubrics) ? entry.rubrics : [];
    const detectedType = (rubricsArray?.[0] as any)?.rubric_type;
    const fallbackType: RubricType = rubricsArray.length <= 1 ? 'holistik' : 'analitik';
    const resolvedType = detectedType === 'holistik' || detectedType === 'analitik' ? detectedType : fallbackType;
    setRubricType(resolvedType);

    const normalizedRubrics = rubricsArray.map((r: any) => ({
      ...r,
      descriptors: Object.entries(r?.descriptors || {}).map(([score, description]) => ({
        score: String(score),
        description: formatDescriptor(description),
      })),
    }));
    if (resolvedType === 'analitik') {
      setAnalyticRubrics(
        normalizedRubrics.length
          ? normalizedRubrics.map((r: any) => ({
              ...r,
              rubric_type: 'analitik',
              nama_aspek: (r.nama_aspek || '').trim(),
              descriptors: r.descriptors?.length ? r.descriptors : [{ score: '', description: '' }],
            }))
          : [{ nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] }]
      );
    } else {
      const first = normalizedRubrics[0];
      setHolisticAspectName((first?.nama_aspek || '').trim() || 'Penilaian Holistik');
      setHolisticDescriptors(first?.descriptors?.length ? first.descriptors : [{ score: '', description: '' }]);
    }
  };

  const loadQuestionBankEntries = async (searchText?: string) => {
    setBankLoading(true);
    setBankError('');
    try {
      const q = (searchText ?? bankQuery).trim();
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      const url = qs.toString() ? `/api/question-bank?${qs.toString()}` : '/api/question-bank';
      const res = await fetch(url, { credentials: 'include' });
      const body = await res.json().catch(() => []);
      if (!res.ok) throw new Error(body?.message || 'Gagal memuat bank soal.');
      setBankEntries(Array.isArray(body) ? body : []);
    } catch (err: any) {
      setBankError(err?.message || 'Gagal memuat bank soal.');
    } finally {
      setBankLoading(false);
    }
  };

  const handleSaveToQuestionBank = async () => {
    if (!teksSoal.trim()) {
      setError('Teks soal wajib diisi sebelum simpan ke bank soal.');
      return;
    }
    setIsSavingToBank(true);
    setError('');
    setBankNotice('');
    try {
      const parsedKeywords = keywords
        .split(',')
        .map((k) => k.trim())
        .filter(Boolean);
      const parsedWeight = weight === '' ? null : Number(weight);
      const payload = {
        material_id: materialId,
        question_id: existingQuestion?.id || null,
        teks_soal: teksSoal,
        level_kognitif: levelKognitif || null,
        ideal_answer: idealAnswer || null,
        keywords: parsedKeywords.length ? parsedKeywords : null,
        weight: parsedWeight,
        rubrics: transformRubricsForSave(),
      };
      const currentSignature = JSON.stringify(payload);
      if (currentSignature === lastSavedBankSignature) {
        setBankNotice('Soal ini sudah tersimpan ke Bank Soal. Ubah isi soal dulu jika ingin simpan lagi.');
        return;
      }
      const res = await fetch('/api/question-bank', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload),
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(body?.message || 'Gagal menyimpan ke bank soal.');
      setError('');
      setBankNotice('Soal berhasil disimpan ke Bank Soal.');
      setLastSavedBankSignature(currentSignature);
    } catch (err: any) {
      setError(err?.message || 'Gagal menyimpan ke bank soal.');
      return;
    } finally {
      setIsSavingToBank(false);
    }
  };

  const addAnalyticAspect = () => {
    setAnalyticRubrics((prev) => [...prev, { nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] }]);
  };

  const removeAnalyticAspect = (aspectIdx: number) => {
    setAnalyticRubrics((prev) => prev.filter((_, idx) => idx !== aspectIdx));
  };

  const updateAnalyticAspectName = (aspectIdx: number, value: string) => {
    setAnalyticRubrics((prev) =>
      prev.map((aspect, idx) => (idx === aspectIdx ? { ...aspect, nama_aspek: value } : aspect))
    );
  };

  const addAnalyticScoreRow = (aspectIdx: number) => {
    setAnalyticRubrics((prev) =>
      prev.map((aspect, idx) =>
        idx === aspectIdx
          ? { ...aspect, descriptors: [...aspect.descriptors, { score: '', description: '' }] }
          : aspect
      )
    );
  };

  const removeAnalyticScoreRow = (aspectIdx: number, scoreIdx: number) => {
    setAnalyticRubrics((prev) =>
      prev.map((aspect, idx) =>
        idx === aspectIdx
          ? { ...aspect, descriptors: aspect.descriptors.filter((_, dIdx) => dIdx !== scoreIdx) }
          : aspect
      )
    );
  };

  const updateAnalyticScoreField = (
    aspectIdx: number,
    scoreIdx: number,
    field: 'score' | 'description',
    value: string
  ) => {
    setAnalyticRubrics((prev) =>
      prev.map((aspect, idx) =>
        idx === aspectIdx
          ? {
              ...aspect,
              descriptors: aspect.descriptors.map((d, dIdx) =>
                dIdx === scoreIdx ? { ...d, [field]: value } : d
              ),
            }
          : aspect
      )
    );
  };

  const addHolisticScoreRow = () => {
    setHolisticDescriptors((prev) => [...prev, { score: '', description: '' }]);
  };

  const removeHolisticScoreRow = (scoreIdx: number) => {
    setHolisticDescriptors((prev) => prev.filter((_, idx) => idx !== scoreIdx));
  };

  const handleAutoGenerate = async () => {
    setError('');
    setIsGenerating(true);
    try {
      const res = await fetch(`/api/materials/${materialId}/essay-questions/auto-generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          rubric_type: rubricType,
          reference_material_id: selectedRAGMaterialId === "__all__" ? null : selectedRAGMaterialId,
        }),
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(body?.message || 'Gagal generate soal otomatis.');
      }

      const generated = body as AutoGeneratedQuestion;
      setTeksSoal(generated.teks_soal || '');
      setIdealAnswer(generated.ideal_answer || '');
      setKeywords(Array.isArray(generated.keywords) ? generated.keywords.join(', ') : '');
      setWeight(typeof generated.weight === 'number' ? generated.weight : '');

      const normalizedType: RubricType =
        generated.rubric_type === 'holistik' || generated.rubric_type === 'analitik'
          ? generated.rubric_type
          : rubricType;
      setRubricType(normalizedType);

      if (normalizedType === 'analitik') {
        const analytic = Array.isArray(generated.rubrics)
          ? generated.rubrics.map((aspect, idx) => ({
              nama_aspek: (aspect?.nama_aspek || '').trim() || `Aspek ${idx + 1}`,
              rubric_type: 'analitik' as RubricType,
              descriptors: Array.isArray(aspect?.descriptors)
                ? aspect.descriptors.map((d) => ({
                    score: String(d.score ?? ''),
                    description: String(d.description ?? ''),
                  }))
                : [],
            }))
          : [];
        setAnalyticRubrics(
          analytic.length
            ? analytic
            : [{ nama_aspek: '', rubric_type: 'analitik', descriptors: [{ score: '', description: '' }] }]
        );
      } else {
        const first = Array.isArray(generated.rubrics) ? generated.rubrics[0] : null;
        setHolisticAspectName((first?.nama_aspek || '').trim() || 'Penilaian Holistik');
        const holistic = Array.isArray(first?.descriptors)
          ? first!.descriptors.map((d) => ({
              score: String(d.score ?? ''),
              description: String(d.description ?? ''),
            }))
          : [];
        setHolisticDescriptors(holistic.length ? holistic : [{ score: '', description: '' }]);
      }
      setStep(1);
    } catch (err: any) {
      const msg = err?.message || 'Gagal generate soal otomatis.';
      setError(msg);
    } finally {
      setIsGenerating(false);
    }
  };

  const cognitiveLevels = ['C1', 'C2', 'C3', 'C4'];
  const parsedKeywords = keywords.split(',').map((k) => k.trim()).filter(Boolean);
  const isCurrentDraftSavedToBank = (() => {
    const parsedWeight = weight === '' ? null : Number(weight);
    const parsedKeywords = keywords
      .split(',')
      .map((k) => k.trim())
      .filter(Boolean);
    const payload = {
      material_id: materialId,
      question_id: existingQuestion?.id || null,
      teks_soal: teksSoal,
      level_kognitif: levelKognitif || null,
      ideal_answer: idealAnswer || null,
      keywords: parsedKeywords.length ? parsedKeywords : null,
      weight: parsedWeight,
      rubrics: transformRubricsForSave(),
    };
    return JSON.stringify(payload) === lastSavedBankSignature && lastSavedBankSignature !== '';
  })();
  const totalRubricMax = activeRubrics.reduce((sum, r) => {
    const scores = r.descriptors.map((d) => Number(d.score)).filter((n) => !Number.isNaN(n));
    return sum + (scores.length ? Math.max(...scores) : 0);
  }, 0);
  const stepLabel = step === 1 ? 'Soal Inti' : step === 2 ? 'Rubrik' : 'Preview';

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title={existingQuestion ? 'Edit Soal Essay' : 'Buat Soal Essay'}
      panelClassName="max-w-[96vw] md:max-w-[90vw] xl:max-w-[82vw] h-[90vh] overflow-hidden"
    >
      <form onSubmit={handleSubmit} className="h-full flex flex-col gap-4">
        {error && (
          <div className="p-3 bg-red-50 text-red-600 rounded-md text-sm">
            {error}
          </div>
        )}
        {bankNotice && (
          <div className="p-3 bg-emerald-50 text-emerald-700 rounded-md text-sm">
            {bankNotice}
          </div>
        )}
        <div className="flex items-center justify-between rounded-xl border border-slate-200 bg-white p-2 shadow-sm">
          <div className="inline-flex rounded-lg border border-slate-200 bg-slate-50 p-1 text-sm">
            <button
              type="button"
              onClick={() => setQuestionMode('manual')}
              className={`rounded-md px-3 py-1.5 font-medium ${questionMode === 'manual' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-600'}`}
            >
              Mode Manual
            </button>
            <button
              type="button"
              onClick={() => setQuestionMode('auto')}
              className={`rounded-md px-3 py-1.5 font-medium ${questionMode === 'auto' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-600'}`}
            >
              Mode Auto (AI)
            </button>
          </div>
          {questionMode === 'auto' && (
            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => {
                  setIsBankPickerOpen(true);
                  loadQuestionBankEntries();
                }}
                className="sage-button-outline"
              >
                Panggil Bank Soal
              </button>
              <button
                type="button"
                onClick={handleAutoGenerate}
                disabled={isGenerating}
                className="sage-button"
              >
                {isGenerating ? 'Generating...' : 'Generate dari Materi'}
              </button>
            </div>
          )}
          {questionMode === 'manual' && (
            <button
              type="button"
              onClick={() => {
                setIsBankPickerOpen(true);
                loadQuestionBankEntries();
              }}
              className="sage-button-outline"
            >
              Panggil Bank Soal
            </button>
          )}
        </div>
        <div className="grid grid-cols-3 gap-2 rounded-xl border border-slate-200 bg-white p-1.5 text-sm shadow-sm">
          {[1, 2, 3].map((i) => (
            <button
              key={i}
              type="button"
              onClick={() => goToStep(i)}
              className={`rounded-lg px-3 py-2 font-medium transition ${
                step === i ? 'bg-[color:var(--sage-700)] text-white shadow-sm' : 'text-slate-600 hover:bg-slate-50'
              }`}
            >
              {i}. {i === 1 ? 'Soal' : i === 2 ? 'Rubrik' : 'Preview'}
            </button>
          ))}
        </div>

        <div className="flex-1 min-h-0 overflow-y-auto pr-1">
          {step === 1 && (
            <section className="grid grid-cols-1 gap-4 lg:grid-cols-5">
              <div className="space-y-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm lg:col-span-3">
                <div className="flex items-center justify-between gap-3">
                  <h3 className="font-semibold text-[color:var(--ink-700)]">Soal Inti</h3>
                  <span className="rounded-full bg-slate-100 px-2.5 py-1 text-xs text-slate-600">Wajib</span>
                </div>
                <div>
                  <label className="text-sm font-medium">Teks Soal</label>
                  <textarea
                    value={teksSoal}
                    onChange={(e) => setTeksSoal(e.target.value)}
                    rows={7}
                    className="sage-input mt-1 text-justify"
                    required
                  />
                </div>
              </div>

              <div className="space-y-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4 shadow-sm lg:col-span-2">
                <h3 className="font-semibold text-[color:var(--ink-700)]">Parameter Soal</h3>
                <div>
                  <label className="text-sm font-medium flex items-center gap-2">
                    Materi Acuan RAG
                    <span
                      className="inline-flex h-4 w-4 items-center justify-center rounded-full border border-slate-300 text-[10px] text-slate-600 cursor-help"
                      title="Default memakai materi saat ini. Bisa diganti ke materi lain dalam kelas. Jika pilih Semua materi kelas, RAG akan memakai gabungan konten seluruh materi di kelas."
                    >
                      ?
                    </span>
                  </label>
                  <select value={selectedRAGMaterialId} onChange={(e) => setSelectedRAGMaterialId(e.target.value)} className="sage-input mt-1 bg-white">
                    <option value="__all__">Semua materi di kelas (RAG umum)</option>
                    {ragMaterials.map((m) => (
                      <option key={m.id} value={m.id}>{m.judul}</option>
                    ))}
                  </select>
                  {ragMaterials.length === 0 && (
                    <p className="mt-1 text-xs text-slate-500">Daftar materi kelas belum tersedia. Default tetap materi saat ini.</p>
                  )}
                </div>
                <div>
                  <label className="text-sm font-medium">Level Kognitif</label>
                  <select
                    value={levelKognitif}
                    onChange={(e) => setLevelKognitif(e.target.value)}
                    className="sage-input mt-1 bg-white"
                  >
                    <option value="">Opsional</option>
                    {cognitiveLevels.map((c) => (
                      <option key={c} value={c}>
                        {c}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-sm font-medium">Bobot Soal</label>
                  <input
                    type="number"
                    step="0.01"
                    value={weight}
                    onChange={(e) => setWeight(e.target.value)}
                    className="sage-input mt-1 bg-white"
                    placeholder="Contoh: 20"
                  />
                </div>

                <button
                  type="button"
                  onClick={() => setShowAdvanced((prev) => !prev)}
                  className="inline-flex items-center gap-1 text-sm font-medium text-[color:var(--sage-700)]"
                >
                  {showAdvanced ? <FiChevronUp /> : <FiChevronDown />}
                  Jawaban Ideal & Kata Kunci
                </button>

                {showAdvanced && (
                  <div className="space-y-3 rounded-lg border border-slate-200 bg-white p-3">
                    <textarea
                      placeholder="Jawaban ideal (opsional)"
                      value={idealAnswer}
                      onChange={(e) => setIdealAnswer(e.target.value)}
                      rows={3}
                      className="sage-input"
                    />
                    <textarea
                      placeholder="Kata kunci, pisahkan dengan koma"
                      value={keywords}
                      onChange={(e) => setKeywords(e.target.value)}
                      rows={2}
                      className="sage-input"
                    />
                  </div>
                )}
              </div>
            </section>
          )}

          {step === 2 && (
            <section className="space-y-4">
              <div className="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                <h3 className="font-semibold text-[color:var(--ink-700)] mb-2">Tipe Rubrik</h3>
                <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
                  <button
                    type="button"
                    onClick={() => handleRubricTypeChange('analitik')}
                    className={`rounded-xl border p-3 text-left transition ${
                      rubricType === 'analitik'
                        ? 'border-[color:var(--sage-700)] bg-[color:var(--sage-50)] shadow-sm'
                        : 'border-slate-200 bg-white hover:bg-slate-50'
                    }`}
                  >
                    <p className="font-semibold text-slate-900">Analitik</p>
                    <p className="text-xs text-slate-600">Skor per aspek (mis. relevansi, pemahaman, analisis).</p>
                  </button>
                  <button
                    type="button"
                    onClick={() => handleRubricTypeChange('holistik')}
                    className={`rounded-xl border p-3 text-left transition ${
                      rubricType === 'holistik'
                        ? 'border-[color:var(--sage-700)] bg-[color:var(--sage-50)] shadow-sm'
                        : 'border-slate-200 bg-white hover:bg-slate-50'
                    }`}
                  >
                    <p className="font-semibold text-slate-900">Holistik</p>
                    <p className="text-xs text-slate-600">Satu aspek penilaian untuk kualitas jawaban secara keseluruhan.</p>
                  </button>
                </div>
              </div>

              <div className="space-y-4 rounded-xl border border-slate-200 bg-slate-50/70 p-4 shadow-sm">
                <div className="flex items-center justify-between gap-3">
                  <h3 className="font-semibold text-[color:var(--ink-700)]">Rubrik Penilaian</h3>
                  {rubricType === 'analitik' && (
                    <button
                      type="button"
                      onClick={addAnalyticAspect}
                      className="sage-button-outline"
                    >
                      + Tambah Aspek
                    </button>
                  )}
                  {rubricType === 'holistik' && (
                    <button
                      type="button"
                      onClick={addHolisticScoreRow}
                      className="sage-button-outline"
                    >
                      + Tambah Skor
                    </button>
                  )}
                </div>

                {activeRubrics.length === 0 && (
                  <p className="text-sm text-slate-500">
                    {rubricType === 'analitik'
                      ? 'Belum ada rubrik. Klik "Tambah Rubrik" untuk menambah skor-deskripsi.'
                      : 'Belum ada rubrik holistik. Tambahkan minimal satu deskriptor.'}
                  </p>
                )}

                {rubricType === 'analitik' &&
                  analyticRubrics.map((rubric, i) => (
                    <div key={i} className="space-y-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                      <div className="flex items-center gap-2">
                        <input
                          value={rubric.nama_aspek}
                          onChange={(e) => updateAnalyticAspectName(i, e.target.value)}
                          className="font-semibold bg-transparent border-b border-slate-200 outline-none w-full pb-1"
                          placeholder={`Nama aspek ${i + 1} (contoh: Relevansi)`}
                        />
                        <button
                          type="button"
                          onClick={() => removeAnalyticAspect(i)}
                          className="text-red-500"
                          aria-label="Hapus aspek"
                        >
                          <FiTrash2 />
                        </button>
                      </div>

                      {rubric.descriptors.map((d, j) => (
                        <div key={j} className="grid grid-cols-1 gap-2 md:grid-cols-[110px_1fr_auto]">
                          <input
                            value={d.score}
                            onChange={(e) => updateAnalyticScoreField(i, j, 'score', e.target.value)}
                            className="sage-input"
                            placeholder="Skor"
                          />
                          <input
                            value={d.description}
                            onChange={(e) => updateAnalyticScoreField(i, j, 'description', e.target.value)}
                            className="sage-input"
                            placeholder="Deskripsi"
                          />
                          <button
                            type="button"
                            onClick={() => removeAnalyticScoreRow(i, j)}
                            className="rounded-md border border-slate-200 px-2 text-red-500 hover:bg-red-50"
                            aria-label="Hapus skor"
                          >
                            <FiTrash2 />
                          </button>
                        </div>
                      ))}

                      <button
                        type="button"
                        onClick={() => addAnalyticScoreRow(i)}
                        className="text-sm font-medium text-[color:var(--sage-700)]"
                      >
                        + Tambah Skor
                      </button>
                    </div>
                  ))}

                {rubricType === 'holistik' && (
                  <div className="space-y-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                    <input
                      value={holisticAspectName}
                      onChange={(e) => setHolisticAspectName(e.target.value)}
                      className="font-semibold bg-transparent border-b border-slate-200 outline-none w-full pb-1"
                      placeholder="Penilaian Holistik"
                    />

                    {holisticDescriptors.map((d, j) => (
                      <div key={j} className="grid grid-cols-1 gap-2 md:grid-cols-[110px_1fr_auto]">
                        <input
                          value={d.score}
                          onChange={(e) =>
                            setHolisticDescriptors((prev) =>
                              prev.map((item, idx) => (idx === j ? { ...item, score: e.target.value } : item))
                            )
                          }
                          className="sage-input"
                          placeholder="Skor"
                        />
                        <input
                          value={d.description}
                          onChange={(e) =>
                            setHolisticDescriptors((prev) =>
                              prev.map((item, idx) => (idx === j ? { ...item, description: e.target.value } : item))
                            )
                          }
                          className="sage-input"
                          placeholder="Deskripsi"
                        />
                        <button
                          type="button"
                          onClick={() => removeHolisticScoreRow(j)}
                          className="rounded-md border border-slate-200 px-2 text-red-500 hover:bg-red-50"
                          aria-label="Hapus skor holistik"
                        >
                          <FiTrash2 />
                        </button>
                      </div>
                    ))}

                    <button
                      type="button"
                      onClick={addHolisticScoreRow}
                      className="text-sm font-medium text-[color:var(--sage-700)]"
                    >
                      + Tambah Skor
                    </button>
                  </div>
                )}
              </div>
            </section>
          )}

          {step === 3 && (
            <section className="space-y-4 border rounded-lg p-4">
              <h3 className="font-semibold text-[color:var(--ink-700)]">Preview Soal</h3>
              <div className="sage-card p-4 space-y-3 border border-slate-200 shadow-sm">
                <p className="text-sm text-slate-500">Langkah: {stepLabel}</p>
                <p className="font-semibold text-slate-900 text-lg">{teksSoal || '-'}</p>
                <div className="flex flex-wrap gap-2 text-xs">
                  <span className="sage-pill">
                    Materi Acuan: {selectedRAGMaterialId === "__all__"
                      ? "Semua materi kelas"
                      : (ragMaterials.find((m) => m.id === selectedRAGMaterialId)?.judul ?? "Materi saat ini")}
                  </span>
                  <span className="sage-pill">Level: {levelKognitif || '-'}</span>
                  <span className="sage-pill">Bobot: {weight || '-'}</span>
                  <span className="sage-pill">Tipe Rubrik: {rubricType === 'holistik' ? 'Holistik' : 'Analitik'}</span>
                  <span className="sage-pill">Aspek Rubrik: {activeRubrics.length}</span>
                  <span className="sage-pill">Skor Maks Total: {totalRubricMax}</span>
                </div>
                {parsedKeywords.length > 0 && (
                  <div>
                    <p className="text-sm font-medium text-slate-700 mb-1">Kata Kunci</p>
                    <div className="flex flex-wrap gap-2">
                      {parsedKeywords.map((k, idx) => <span key={idx} className="sage-pill">{k}</span>)}
                    </div>
                  </div>
                )}
                {idealAnswer && (
                  <div>
                    <p className="text-sm font-medium text-slate-700 mb-1">Jawaban Ideal</p>
                    <p className="text-sm text-slate-600 whitespace-pre-line">{idealAnswer}</p>
                  </div>
                )}
              </div>

              <div className="space-y-2">
                {activeRubrics.map((r, idx) => (
                  <div key={idx} className="border border-slate-200 rounded-lg p-3 bg-white shadow-sm">
                    <p className="font-semibold text-slate-800">{r.nama_aspek || `Aspek ${idx + 1}`}</p>
                    <ul className="mt-2 text-sm text-slate-600 space-y-1">
                      {r.descriptors.map((d, i) => (
                        <li key={i}><strong>{d.score || '-'}</strong>: {d.description || '-'}</li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>

        <div className="flex items-center justify-between gap-3 pt-3 border-t border-slate-100">
          <button type="button" onClick={onClose} className="sage-button-outline">Batal</button>
          <div className="flex gap-2">
            <button
              type="button"
              className="sage-button-outline"
              onClick={handleSaveToQuestionBank}
              disabled={isSavingToBank || isCurrentDraftSavedToBank}
            >
              {isSavingToBank ? 'Menyimpan ke Bank...' : isCurrentDraftSavedToBank ? 'Sudah Tersimpan' : 'Simpan ke Bank Soal'}
            </button>
            <button
              type="button"
              className="sage-button-outline"
              onClick={() => setStep((s) => Math.max(1, s - 1))}
              disabled={step === 1}
            >
              Kembali
            </button>
            {step < 3 ? (
              <button
                type="button"
                className="sage-button"
                onClick={() => goToStep(step + 1)}
              >
                Lanjut
              </button>
            ) : (
              <button
                type="submit"
                className="sage-button"
              >
                Simpan Soal
              </button>
            )}
          </div>
        </div>
      </form>
      <QuestionBankPickerModal
        isOpen={isBankPickerOpen}
        onClose={() => setIsBankPickerOpen(false)}
        entries={bankEntries}
        loading={bankLoading}
        error={bankError}
        query={bankQuery}
        onQueryChange={(value) => setBankQuery(value)}
        onRefresh={() => loadQuestionBankEntries(bankQuery)}
        onPick={(entry) => {
          applyQuestionBankEntry(entry);
          setIsBankPickerOpen(false);
          setStep(1);
        }}
      />
    </Modal>
  );
};

// --- MAIN PAGE COMPONENT ---
export default function MaterialDetailsPage() {
  const params = useParams();
  const router = useRouter();
  const materialId = params.materialId as string;

  const [material, setMaterial] = useState<MaterialDetail | null>(null);
  const [classMaterials, setClassMaterials] = useState<RAGMaterialOption[]>([]);
  const [questions, setQuestions] = useState<EssayQuestion[]>([]);
  const [submissions, setSubmissions] = useState<Submission[]>([]); // New state for submissions
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isReviewModalOpen, setReviewModalOpen] = useState(false);
  const [reviewingSubmission, setReviewingSubmission] = useState<Submission | null>(null);

  const handleOpenReviewModal = (submission: Submission) => {
    setReviewingSubmission(submission);
    setReviewModalOpen(true);
  };

  const [isEditMaterialModalOpen, setEditMaterialModalOpen] = useState(false); // New state for Edit Material modal
  const [isEditQuestionModalOpen, setEditQuestionModalOpen] = useState(false);
  const [editingQuestion, setEditingQuestion] = useState<EssayQuestion | null>(null);
  const [activeTab, setActiveTab] = useState('overview'); // Default to overview tab
  const [confirmDeleteMaterialOpen, setConfirmDeleteMaterialOpen] = useState(false);
  const [pendingDeleteQuestionId, setPendingDeleteQuestionId] = useState<string | null>(null);
  const [actionLoading, setActionLoading] = useState(false);
  const [notice, setNotice] = useState<{ open: boolean; title: string; message: string; tone: "info" | "success" | "error" }>({
    open: false,
    title: "",
    message: "",
    tone: "info",
  });

  const fetchData = useCallback(async () => {
    if (!materialId) return;
    setIsLoading(true);
    setError(null);
    try {
      const [materialRes, questionsRes] = await Promise.all([
        fetch(`/api/materials/${materialId}`),
        fetch(`/api/materials/${materialId}/essay-questions`),
      ]);

      if (!materialRes.ok) throw new Error('Gagal memuat detail materi.');
      if (!questionsRes.ok) throw new Error('Gagal memuat soal-soal untuk materi ini.');
      
      const materialData = await materialRes.json();
      const questionsData = await questionsRes.json();

      let ragMaterialOptions: RAGMaterialOption[] = [];
      try {
        const classMaterialsRes = await fetch(`/api/classes/${materialData.class_id}/materials`, { credentials: 'include' });
        if (classMaterialsRes.ok) {
          const classMaterialsData = await classMaterialsRes.json();
          ragMaterialOptions = Array.isArray(classMaterialsData)
            ? classMaterialsData.map((m: any) => ({
                id: String(m.id),
                judul: String(m.judul || "Tanpa Judul"),
                material_type: (m.material_type || "materi") as "materi" | "soal" | "tugas",
              }))
            : [];
        }
      } catch {
        // fallback below
      }
      if (!ragMaterialOptions.some((m) => m.id === materialData.id)) {
        ragMaterialOptions = [
          { id: materialData.id, judul: materialData.judul || "Materi saat ini", material_type: materialData.material_type || "materi" },
          ...ragMaterialOptions,
        ];
      }
      setClassMaterials(ragMaterialOptions);

      const processedQuestions = questionsData.map((q: EssayQuestion) => {
          let rubricsArray: Rubric[] = [];
          if (Array.isArray(q.rubrics)) {
              rubricsArray = q.rubrics;
          }
          return {
              ...q,
              rubrics: rubricsArray.map((rubric) => ({
                  ...rubric,
                  descriptors: Object.entries(rubric.descriptors || {}).map(([score, description]) => ({
                    score: String(score),
                    description: formatDescriptor(description),
                  }))
              }))
          };
      });

      // Fetch submissions for each question
      const submissionPromises = processedQuestions.map(async (q: EssayQuestion) => {
          const subRes = await fetch(`/api/essay-questions/${q.id}/submissions`);
          if (subRes.ok) {
              const subData = await subRes.json();
              // Add question_id to each submission for easier filtering later
              return subData.map((s: Submission) => ({ ...s, question_id: q.id }));
          } else {
              console.error(`Failed to fetch submissions for question ${q.id}`);
              return [];
          }
      });

      const allSubmissions = (await Promise.all(submissionPromises)).flat();
      setSubmissions(allSubmissions);

      setMaterial(materialData);
      setQuestions(processedQuestions || []);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  }, [materialId]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  useEffect(() => {
    if (!material) return;
    const type = material.material_type || "materi";
    const allowedTabs =
      type === "soal" ? ["questions", "students"] : type === "tugas" ? ["overview", "students"] : ["overview", "questions", "students"];
    if (!allowedTabs.includes(activeTab)) {
      setActiveTab(allowedTabs[0]);
    }
  }, [material, activeTab]);

  const handleDeleteMaterial = async () => {
    if (!material) return;
    setConfirmDeleteMaterialOpen(true);
  };

  const executeDeleteMaterial = async () => {
    if (!material) return;
    setActionLoading(true);
    try {
      const response = await fetch(`/api/materials/${material.id}`, { method: 'DELETE', credentials: 'include' });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Gagal menghapus materi.');
      }
      setNotice({
        open: true,
        title: "Berhasil",
        message: "Materi berhasil dihapus.",
        tone: "success",
      });
      window.setTimeout(() => {
        router.push(`/dashboard/teacher/class/${material.class_id}`);
      }, 600);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setActionLoading(false);
      setConfirmDeleteMaterialOpen(false);
    }
  };

  const handleDeleteQuestion = async (questionId: string) => {
    setPendingDeleteQuestionId(questionId);
  };

  const executeDeleteQuestion = async () => {
    if (!pendingDeleteQuestionId) return;
    setActionLoading(true);
    try {
      const response = await fetch(`/api/essay-questions/${pendingDeleteQuestionId}`, {
        method: 'DELETE',
        credentials: 'include',
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Gagal menghapus soal.');
      }
      setNotice({
        open: true,
        title: "Berhasil",
        message: "Soal berhasil dihapus.",
        tone: "success",
      });
      fetchData();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setActionLoading(false);
      setPendingDeleteQuestionId(null);
    }
  };

  const handleOpenEditQuestionModal = (question: EssayQuestion) => {
      setEditingQuestion(question);
      setEditQuestionModalOpen(true);
  };

  const handleOpenAddQuestionModal = () => {
    setEditingQuestion(null); // Clear any existing question data
    setEditQuestionModalOpen(true);
  };


  if (isLoading) return <div className="p-8 text-center">Memuat data materi...</div>;
  if (error) return <div className="p-8 text-center text-red-500">{error}</div>;
  if (!material) return <div className="p-8 text-center">Materi tidak ditemukan.</div>;

  const contentType = material.material_type || "materi";
  const isSoalType = contentType === "soal";
  const isTugasType = contentType === "tugas";
  const contentTypeLabel = isSoalType ? "Soal" : isTugasType ? "Tugas" : "Materi";

  return (
    <div className="space-y-8">
      {/* Header */}
      <div className="sage-panel p-6">
        <Link href={`/dashboard/teacher/class/${material.class_id}`} className="flex items-center gap-2 text-[color:var(--sage-700)] hover:underline mb-4">
          <FiArrowLeft />
          <span>Kembali ke Detail Kelas</span>
        </Link>
        <div className="flex justify-between items-start">
            <div>
                <h1 className="text-3xl text-[color:var(--ink-900)] font-semibold">{material.judul}</h1>
                <p className="text-sm text-[color:var(--ink-500)]">Detail {contentTypeLabel}</p>
            </div>
            <div className="flex gap-2">
                {!isSoalType && (
                  <button onClick={() => setEditMaterialModalOpen(true)} className="sage-button-outline"><FiEdit/> Edit {contentTypeLabel}</button>
                )}
                <button onClick={handleDeleteMaterial} className="inline-flex items-center gap-2 rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white hover:bg-red-600"><FiTrash2/> Hapus {contentTypeLabel}</button>
            </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-black/10">
          <nav className="flex space-x-4" aria-label="Tabs">
              {!isSoalType && (
                <button onClick={() => setActiveTab('overview')} className={`px-3 py-2 font-medium text-sm rounded-t-lg ${activeTab === 'overview' ? 'border-b-2 border-slate-900 text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>
                    <FiBookOpen className="inline mr-2" />{isTugasType ? "Detail Tugas" : "Ringkasan"}
                </button>
              )}
              {!isTugasType && (
                <button onClick={() => setActiveTab('questions')} className={`px-3 py-2 font-medium text-sm rounded-t-lg ${activeTab === 'questions' ? 'border-b-2 border-slate-900 text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>
                    <FiHelpCircle className="inline mr-2" />{isSoalType ? `Daftar Soal (${questions.length})` : `Daftar Soal(${questions.length})`}
                </button>
              )}
              <button onClick={() => setActiveTab('students')} className={`px-3 py-2 font-medium text-sm rounded-t-lg ${activeTab === 'students' ? 'border-b-2 border-slate-900 text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>
                  <FiUsers className="inline mr-2" />Submisi Siswa ({new Set(submissions.map(s => s.student_id)).size})
              </button>
          </nav>
      </div>

      {/* Tab Content */}
      <div>
          {activeTab === 'overview' && !isSoalType && (
              <OverviewSection material={material} questions={questions} submissions={submissions} />
          )}
          {activeTab === 'questions' && !isTugasType && (
              <QuestionsListSection questions={questions} handleOpenAddQuestionModal={handleOpenAddQuestionModal} handleOpenEditQuestionModal={handleOpenEditQuestionModal} handleDeleteQuestion={handleDeleteQuestion} />
          )}
          {activeTab === 'students' && (
              <StudentSubmissionsList submissions={submissions} questions={questions} handleOpenReviewModal={handleOpenReviewModal} onFinished={fetchData} />
          )}
      </div>
      {/* Modals */}
      {!isTugasType && (
        <EssayQuestionFormModal
          isOpen={isEditQuestionModalOpen}
          onClose={() => setEditQuestionModalOpen(false)}
          materialId={materialId}
          ragMaterials={classMaterials}
          onFinished={fetchData}
          existingQuestion={editingQuestion}
        />
      )}
      <ReviewModal isOpen={isReviewModalOpen} onClose={() => setReviewModalOpen(false)} submission={reviewingSubmission} onFinished={fetchData} />
    
      {/* Edit Material Modal */}
      {material && !isSoalType && <EditMaterialModal isOpen={isEditMaterialModalOpen} onClose={() => setEditMaterialModalOpen(false)} material={material} onFinished={fetchData} />}

      <ConfirmDialog
        isOpen={confirmDeleteMaterialOpen}
        title="Hapus Materi"
        message={`Apakah Anda yakin ingin menghapus materi "${material.judul}"? Semua soal di dalamnya juga akan terhapus.`}
        confirmLabel="Hapus"
        danger
        loading={actionLoading}
        onCancel={() => setConfirmDeleteMaterialOpen(false)}
        onConfirm={executeDeleteMaterial}
      />

      <ConfirmDialog
        isOpen={!!pendingDeleteQuestionId}
        title="Hapus Soal"
        message="Apakah Anda yakin ingin menghapus soal ini?"
        confirmLabel="Hapus"
        danger
        loading={actionLoading}
        onCancel={() => setPendingDeleteQuestionId(null)}
        onConfirm={executeDeleteQuestion}
      />

      <NoticeDialog
        isOpen={notice.open}
        title={notice.title}
        message={notice.message}
        tone={notice.tone}
        onClose={() => setNotice((prev) => ({ ...prev, open: false }))}
      />

      <LoadingDialog isOpen={actionLoading} message="Sedang memproses permintaan..." />
    </div>
  );
}
// --- LIST SUB-COMPONENTS ---
const OverviewSection = ({
  material,
  questions,
  submissions,
}: {
  material: MaterialDetail;
  questions: EssayQuestion[];
  submissions: Submission[];
}) => {
  const uniqueStudents = new Set(submissions.map((s) => s.student_id)).size;
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
        <div className="sage-card p-5">
          <p className="text-xs text-slate-500">Total Soal</p>
          <p className="text-2xl font-semibold text-slate-900">{questions.length}</p>
        </div>
        <div className="sage-card p-5">
          <p className="text-xs text-slate-500">Total Submisi</p>
          <p className="text-2xl font-semibold text-slate-900">{submissions.length}</p>
        </div>
        <div className="sage-card p-5">
          <p className="text-xs text-slate-500">Siswa Terlibat</p>
          <p className="text-2xl font-semibold text-slate-900">{uniqueStudents}</p>
        </div>
      </div>

      <div className="sage-panel p-6">
        <h2 className="text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2">
          <FiFileText /> Isi Materi
        </h2>
        <MaterialContentRenderer isiMateri={material.isi_materi} fileUrl={material.file_url} />
      </div>
    </div>
  );
};

const QuestionsListSection = ({
  questions,
  handleOpenAddQuestionModal,
  handleOpenEditQuestionModal,
  handleDeleteQuestion,
}: {
  questions: EssayQuestion[];
  handleOpenAddQuestionModal: () => void;
  handleOpenEditQuestionModal: (question: EssayQuestion) => void;
  handleDeleteQuestion: (questionId: string) => void;
}) => {
  const [expandedId, setExpandedId] = useState<string | null>(null);

  return (
    <div className="space-y-6">
      <div className="sage-panel p-6 flex flex-wrap items-center justify-between gap-4">
        <div>
          <h2 className="text-xl font-semibold text-slate-900 flex items-center gap-2">
            <FiHelpCircle />
            Daftar Soal
          </h2>
          <p className="text-sm text-slate-500">Kelola pertanyaan dan rubrik penilaian.</p>
        </div>
        <button onClick={handleOpenAddQuestionModal} className="sage-button">
          <FiPlus />
          Tambah Soal
        </button>
      </div>

      {/* LIST */}
      {questions.length === 0 ? (
        <div className="text-center py-16 border-2 border-dashed rounded-2xl text-[color:var(--ink-500)]">
          Belum ada soal untuk materi ini.
        </div>
      ) : (
        <div className="space-y-4">
          {questions.map((q, index) => {
            const isOpen = expandedId === q.id;

            const normalizedKeywords = Array.isArray(q.keywords)
              ? q.keywords
              : typeof q.keywords === "string"
              ? q.keywords.split(",").map((k) => k.trim())
              : [];

            const rubrics = Array.isArray(q.rubrics) ? q.rubrics : [];

            return (
              <div key={q.id} className="sage-card border border-slate-200 shadow-sm transition hover:shadow-md">
                <div
                  className="grid gap-4 p-5 cursor-pointer sm:grid-cols-[1fr_auto]"
                  onClick={() => setExpandedId(isOpen ? null : q.id)}
                >
                  <div className="space-y-2">
                    <p className="font-semibold text-slate-900 text-justify">
                      {index + 1}. {q.teks_soal}
                    </p>
                    <div className="flex flex-wrap gap-2 text-xs text-slate-500">
                      {q.level_kognitif && (
                        <span className="px-2 py-0.5 bg-slate-100 rounded-full">
                          {q.level_kognitif}
                        </span>
                      )}
                      {normalizedKeywords.length > 0 && (
                        <span>{normalizedKeywords.length} keyword</span>
                      )}
                      {rubrics.length > 0 && (
                        <span>{rubrics.length} rubrik</span>
                      )}
                    </div>
                  </div>

                  <div className="flex gap-2 sm:justify-end">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleOpenEditQuestionModal(q);
                      }}
                      className="p-2 text-slate-500 hover:text-slate-800"
                    >
                      <FiEdit />
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDeleteQuestion(q.id);
                      }}
                      className="p-2 text-slate-500 hover:text-red-600"
                    >
                      <FiTrash2 />
                    </button>
                  </div>
                </div>

                {/* DROPDOWN CONTENT */}
                {isOpen && (
                  <div className="border-t border-slate-200 px-6 py-4 bg-slate-50/70 space-y-4 text-sm">
                    {/* IDEAL ANSWER */}
                    {q.ideal_answer && (
                      <div>
                        <p className="font-semibold text-[color:var(--ink-700)] mb-1">
                          Jawaban Ideal
                        </p>
                        <p className="text-[color:var(--ink-500)] whitespace-pre-line">
                          {q.ideal_answer}
                        </p>
                      </div>
                    )}

                    {/* KEYWORDS */}
                    {normalizedKeywords.length > 0 && (
                      <div>
                        <p className="font-semibold text-[color:var(--ink-700)] mb-1">
                          Kata Kunci
                        </p>
                        <div className="flex flex-wrap gap-2">
                          {normalizedKeywords.map((k, i) => (
                            <span
                              key={i}
                              className="px-2 py-1 bg-[color:var(--sand-100)] text-[color:var(--sage-800)] rounded text-xs"
                            >
                              {k}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* RUBRICS */}
                    {rubrics.length > 0 && (
                      <div>
                        <p className="font-semibold text-[color:var(--ink-700)] mb-2">
                          Rubrik Penilaian
                        </p>
                        <div className="space-y-3">
                          {rubrics.map((r: any, ri: number) => (
                            <div
                              key={ri}
                              className="border rounded-lg bg-white p-3"
                            >
                              <p className="font-semibold text-[color:var(--ink-900)] mb-1">
                                {r.nama_aspek}
                              </p>
                              <ul className="text-xs text-[color:var(--ink-500)] space-y-1">
                                {r.descriptors &&
                                  Object.entries(r.descriptors).map(
                                    ([score, desc]: any) => (
                                      <li key={score}>
                                        <strong>{score}</strong>: {formatDescriptor(desc)}
                                      </li>
                                    )
                                  )}
                              </ul>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};



const StudentSubmissionsList = ({
    submissions,
    questions,
    handleOpenReviewModal,
    onFinished
}: {
    submissions: Submission[],
    questions: EssayQuestion[],
    handleOpenReviewModal: (submission: Submission) => void,
    onFinished: () => void
}) => {

    const [openStudentIds, setOpenStudentIds] = useState<string[]>([]);
    const [openSubmissionIds, setOpenSubmissionIds] = useState<string[]>([]);
    const [openRubricDetails, setOpenRubricDetails] = useState<Record<string, boolean>>({});
    const [searchQuery, setSearchQuery] = useState('');
    const [expandedFeedback, setExpandedFeedback] = useState<Record<string, boolean>>({});
    const [confirmDeleteSubmissionId, setConfirmDeleteSubmissionId] = useState<string | null>(null);
    const [deletingSubmissionId, setDeletingSubmissionId] = useState<string | null>(null);
    const [notice, setNotice] = useState<{ open: boolean; title: string; message: string; tone: "info" | "success" | "error" }>({
        open: false,
        title: "",
        message: "",
        tone: "info",
    });

    const toggleStudent = (id: string) => {
        setOpenStudentIds(prev =>
            prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        );
    };

    const toggleSubmission = (id: string) => {
        setOpenSubmissionIds(prev =>
            prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        );
    };

    const handleDeleteSubmission = async (submissionId: string) => {
        setDeletingSubmissionId(submissionId);
        try {
            const res = await fetch(`/api/submissions/${submissionId}`, { method: "DELETE", credentials: "include" });
            if (!res.ok) throw new Error("Delete failed");
            onFinished();
            setNotice({
                open: true,
                title: "Berhasil",
                message: "Submission berhasil dihapus.",
                tone: "success",
            });
        } catch (err: any) {
            setNotice({
                open: true,
                title: "Gagal",
                message: err.message || "Delete failed",
                tone: "error",
            });
        } finally {
            setDeletingSubmissionId(null);
            setConfirmDeleteSubmissionId(null);
        }
    };

    if (submissions.length === 0) {
        return <div className="sage-panel p-10 text-center text-slate-500">Belum ada submisi siswa</div>;
    }

    // ===== GROUP PER SISWA =====
    const submissionsByStudent = submissions.reduce((acc, s) => {
        if (!acc[s.student_id]) {
            acc[s.student_id] = {
                student_name: s.student_name ?? "Unknown",
                student_email: s.student_email ?? "-",
                submissions: []
            };
        }
        acc[s.student_id].submissions.push(s);
        return acc;
    }, {} as Record<string, { student_name: string, student_email: string, submissions: Submission[] }>);

    const getQuestionLabel = (id: string) => {
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return "Soal tidak ditemukan";
        return `${idx + 1}. ${questions[idx].teks_soal}`;
    };

    const normalizeDescriptors = (descriptors: any) => {
        if (!descriptors) return [];
        if (Array.isArray(descriptors)) return descriptors;
        if (typeof descriptors === "object") {
            return Object.entries(descriptors).map(([score, desc]) => ({ score, description: desc }));
        }
        return [];
    };

    const normalizeText = (value: any) => String(value ?? "").trim().toLowerCase();

    const extractNumericScore = (scoreValue: any): number | undefined => {
        const parsed = Number(scoreValue);
        return Number.isFinite(parsed) ? parsed : undefined;
    };

    const getStudentRubricScore = (submission: Submission, rubric: any, rubricIndex: number): number | undefined => {
        if (!Array.isArray(submission.rubric_scores) || submission.rubric_scores.length === 0) {
            return undefined;
        }

        const byRubricID = rubric?.id
            ? submission.rubric_scores.find((r: any) => r?.rubric_id === rubric.id)
            : undefined;
        if (byRubricID) {
            return extractNumericScore(byRubricID.score ?? byRubricID.skor_diperoleh ?? byRubricID.skor);
        }

        const byAspectName = submission.rubric_scores.find(
            (r: any) => normalizeText(r?.aspek ?? r?.nama_aspek) === normalizeText(rubric?.nama_aspek)
        );
        if (byAspectName) {
            return extractNumericScore(byAspectName.score ?? byAspectName.skor_diperoleh ?? byAspectName.skor);
        }

        const byIndex = submission.rubric_scores[rubricIndex];
        if (byIndex) {
            return extractNumericScore(byIndex.score ?? byIndex.skor_diperoleh ?? byIndex.skor);
        }

        return undefined;
    };

    const getFeedbackPreview = (text?: string, expanded?: boolean) => {
        const raw = (text ?? '').trim();
        if (!raw) return '-';
        if (expanded || raw.length <= 100) return raw;
        return `${raw.slice(0, 100)}...`;
    };

    const toggleFeedback = (key: string) => {
        setExpandedFeedback((prev) => ({ ...prev, [key]: !prev[key] }));
    };

    const toggleRubricDetail = (key: string) => {
        setOpenRubricDetails((prev) => ({ ...prev, [key]: !prev[key] }));
    };

    const normalizedQuery = searchQuery.trim().toLowerCase();
    const filteredStudentEntries = Object.entries(submissionsByStudent).filter(([, group]) => {
        if (!normalizedQuery) return true;
        const name = (group.student_name ?? '').toLowerCase();
        const email = (group.student_email ?? '').toLowerCase();
        return name.includes(normalizedQuery) || email.includes(normalizedQuery);
    });

    return (
        <div className="space-y-6">
            <div className="sage-panel p-4">
                <label className="relative block">
                    <FiSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                    <input
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Cari nama atau email siswa..."
                        className="sage-input pl-10"
                    />
                </label>
            </div>

            {filteredStudentEntries.length === 0 && (
                <div className="sage-panel p-8 text-center text-slate-500">
                    Tidak ada siswa yang cocok dengan pencarian.
                </div>
            )}

            {filteredStudentEntries.map(([studentId, group]) => {
                const isOpenStudent = openStudentIds.includes(studentId);
                const reviewedCount = group.submissions.filter(s => s.revised_score != null || s.teacher_feedback).length;
                const totalSubmissions = group.submissions.length;
                const reviewRatio = totalSubmissions > 0 ? reviewedCount / totalSubmissions : 0;
                const reviewToneClass =
                    reviewedCount === 0
                        ? "bg-red-100 text-red-700 border-red-200"
                        : reviewRatio < 1
                            ? "bg-amber-100 text-amber-800 border-amber-200"
                            : "bg-emerald-100 text-emerald-700 border-emerald-200";

                const scoredSubmissions = group.submissions.filter((s) => {
                    const score = s.revised_score ?? s.skor_ai;
                    return typeof score === "number";
                });
                const averageFinalScore = scoredSubmissions.length > 0
                    ? scoredSubmissions.reduce((sum, s) => sum + Number(s.revised_score ?? s.skor_ai ?? 0), 0) / scoredSubmissions.length
                    : null;

                return (
                    <div key={studentId} className="sage-card overflow-hidden">
                        <button
                            className="w-full px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-slate-50 hover:bg-slate-100 transition-colors text-left"
                            onClick={() => toggleStudent(studentId)}
                        >
                            <div className="flex items-center gap-3">
                                <FiUsers className="text-slate-600" />
                                <div>
                                    <p className="font-semibold text-slate-900">{group.student_name}</p>
                                    <p className="text-sm text-slate-500">{group.student_email}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 text-xs text-slate-500">
                                <span className="px-2 py-1 rounded-full bg-blue-100 text-blue-700 border border-blue-200">
                                    {totalSubmissions} Submisi
                                </span>
                                <span className={`px-2 py-1 rounded-full border ${reviewToneClass}`}>
                                    {reviewedCount} Direview
                                </span>
                                <span className="px-2 py-1 rounded-full bg-white border border-slate-200 text-slate-700">
                                    Nilai Akhir: {averageFinalScore == null ? "-" : averageFinalScore.toFixed(1)}
                                </span>
                                {isOpenStudent ? <FiChevronUp /> : <FiChevronDown />}
                            </div>
                        </button>

                        {isOpenStudent && (
                            <div className="divide-y divide-slate-100 bg-white">
                                {group.submissions.map(sub => {
                                    const isOpenSub = openSubmissionIds.includes(sub.id);
                                    const aiFeedbackKey = `${sub.id}-ai`;
                                    const teacherFeedbackKey = `${sub.id}-teacher`;
                                    const aiFeedbackRaw = (sub.umpan_balik_ai ?? '').trim();
                                    const teacherFeedbackRaw = (sub.teacher_feedback ?? '').trim();
                                    const hasLongAIFeedback = aiFeedbackRaw.length > 100;
                                    const hasLongTeacherFeedback = teacherFeedbackRaw.length > 100;
                                    const statusLabel = sub.revised_score != null
                                        ? "Reviewed"
                                        : sub.skor_ai != null
                                            ? "Auto-scored"
                                            : "Pending";

                                    return (
                                        <div key={sub.id} className="px-6 py-5">
                                            <button
                                                className="w-full text-left flex flex-col md:flex-row md:items-center md:justify-between gap-2 hover:bg-slate-50 px-3 py-2 rounded-md transition-colors"
                                                onClick={() => toggleSubmission(sub.id)}
                                            >
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm font-medium text-slate-800 text-justify block">{getQuestionLabel(sub.question_id)}</span>
                                                    <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                                        {statusLabel}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                                    <span>{new Date(sub.submitted_at).toLocaleString()}</span>
                                                    {isOpenSub ? <FiChevronUp /> : <FiChevronDown />}
                                                </div>
                                            </button>

                                            {isOpenSub && (
                                                <div className="mt-3 space-y-4 p-4 rounded-md bg-slate-50 border border-slate-200">
                                                    <div>
                                                        <p className="text-xs uppercase tracking-wide text-slate-500">Jawaban</p>
                                                        <p className="text-sm text-slate-700 mt-1">{sub.teks_jawaban}</p>
                                                    </div>

                                                    <div className="grid md:grid-cols-3 gap-3">
                                                        <div className="bg-white p-3 rounded-md border border-slate-200">
                                                            <p className="text-xs text-slate-500">Skor AI</p>
                                                            <p className="font-semibold text-slate-900">{sub.skor_ai ?? "-"}</p>
                                                            {aiFeedbackRaw && (
                                                                <div className="mt-1">
                                                                    <p className="text-sm text-slate-600">{getFeedbackPreview(sub.umpan_balik_ai, !!expandedFeedback[aiFeedbackKey])}</p>
                                                                    {hasLongAIFeedback && (
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => toggleFeedback(aiFeedbackKey)}
                                                                            className="text-xs font-medium text-[color:var(--sage-700)] hover:underline mt-1"
                                                                        >
                                                                            {!!expandedFeedback[aiFeedbackKey] ? 'Tutup' : 'Baca selengkapnya'}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>

                                                        <div className="bg-white p-3 rounded-md border border-slate-200">
                                                            <p className="text-xs text-slate-500">Skor Guru</p>
                                                            <p className="font-semibold text-slate-900">{sub.revised_score ?? "-"}</p>
                                                            {teacherFeedbackRaw && (
                                                                <div className="mt-1">
                                                                    <p className="text-sm text-slate-600">{getFeedbackPreview(sub.teacher_feedback, !!expandedFeedback[teacherFeedbackKey])}</p>
                                                                    {hasLongTeacherFeedback && (
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => toggleFeedback(teacherFeedbackKey)}
                                                                            className="text-xs font-medium text-[color:var(--sage-700)] hover:underline mt-1"
                                                                        >
                                                                            {!!expandedFeedback[teacherFeedbackKey] ? 'Tutup' : 'Baca selengkapnya'}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>

                                                        {(() => {
                                                            const submissionRubrics = questions.find(q => q.id === sub.question_id)?.rubrics ?? [];
                                                            if (submissionRubrics.length === 0) return null;

                                                            return (
                                                                <div className="bg-white p-3 rounded-md border border-slate-200">
                                                                    <p className="text-xs text-slate-500 font-semibold mb-2">Nilai Per Rubrik</p>
                                                                    {submissionRubrics.map((rubric, i) => {
                                                                        const studentScore = getStudentRubricScore(sub, rubric, i);
                                                                        const descriptors = normalizeDescriptors(rubric.descriptors);
                                                                        const rubricDetailKey = `${sub.id}-${rubric.id ?? rubric.nama_aspek ?? i}`;
                                                                        const isRubricOpen = !!openRubricDetails[rubricDetailKey];
                                                                        return (
                                                                            <div key={i} className="mb-4 last:mb-0">
                                                                                <button
                                                                                    type="button"
                                                                                    onClick={() => toggleRubricDetail(rubricDetailKey)}
                                                                                    className="w-full text-left flex items-center justify-between px-2 py-1.5 rounded-md hover:bg-slate-50 border border-slate-200"
                                                                                >
                                                                                    <p className="text-sm font-semibold text-slate-800">
                                                                                        {rubric.nama_aspek}
                                                                                        <span className="ml-2 text-slate-500">-</span>
                                                                                        <span className="ml-2 font-bold text-slate-900">{studentScore ?? "-"}</span>
                                                                                    </p>
                                                                                    {isRubricOpen ? <FiChevronUp className="text-slate-500" /> : <FiChevronDown className="text-slate-500" />}
                                                                                </button>
                                                                                {isRubricOpen && (
                                                                                    <div className="mt-2 space-y-1.5 text-xs text-slate-600">
                                                                                        {descriptors.map((d: any) => {
                                                                                            const isSelected = studentScore === Number(d.score);
                                                                                            return (
                                                                                                <div
                                                                                                    key={d.score}
                                                                                                    className={`rounded-md px-2 py-1 border ${
                                                                                                        isSelected
                                                                                                            ? "bg-slate-100 border-slate-300 text-slate-900"
                                                                                                            : "bg-white border-slate-200"
                                                                                                    }`}
                                                                                                >
                                                                                                    <span className="font-semibold">{d.score}:</span>{" "}
                                                                                                    {formatDescriptor(d.description)}
                                                                                                </div>
                                                                                            );
                                                                                        })}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>

                                                    <div className="flex gap-2">
                                                        <button
                                                            className="sage-button"
                                                            onClick={() => handleOpenReviewModal(sub)}
                                                        >
                                                            <FiEdit /> Review
                                                        </button>
                                                        <button
                                                            className="sage-button-outline"
                                                            onClick={() => setConfirmDeleteSubmissionId(sub.id)}
                                                        >
                                                            <FiTrash2 /> Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            })}

            <ConfirmDialog
                isOpen={!!confirmDeleteSubmissionId}
                title="Hapus Submission"
                message="Delete submission beserta AI result dan teacher review?"
                confirmLabel="Hapus"
                danger
                loading={!!deletingSubmissionId}
                onCancel={() => setConfirmDeleteSubmissionId(null)}
                onConfirm={() => {
                    if (!confirmDeleteSubmissionId) return;
                    handleDeleteSubmission(confirmDeleteSubmissionId);
                }}
            />

            <NoticeDialog
                isOpen={notice.open}
                title={notice.title}
                message={notice.message}
                tone={notice.tone}
                onClose={() => setNotice((prev) => ({ ...prev, open: false }))}
            />

            <LoadingDialog isOpen={!!deletingSubmissionId} message="Menghapus submission..." />
        </div>
    );
};

// --- REVIEW MODAL ---
const ReviewModal = ({ isOpen, onClose, submission, onFinished }: { isOpen: boolean, onClose: () => void, submission: Submission | null, onFinished: () => void }) => {
    const [revisedScore, setRevisedScore] = useState<string | number>('');
    const [teacherFeedback, setTeacherFeedback] = useState('');
    const [error, setError] = useState('');
    const [reviewId, setReviewId] = useState<string | null>(null); // To store existing review ID

    useEffect(() => {
        const fetchReview = async () => {
            if (submission?.id) {
                try {
                    const res = await fetch(`/api/teacher-reviews/submission/${submission.id}`, {
                        credentials: 'include',
                    });
                    if (res.ok) {
                        const reviewData = await res.json();
                        setReviewId(reviewData.id);
                        setRevisedScore(reviewData.revised_score ?? '');
                        setTeacherFeedback(reviewData.teacher_feedback ?? '');
                    } else if (res.status === 404) {
                        // No existing review, treat as new
                        setReviewId(null);
                        setRevisedScore('');
                        setTeacherFeedback('');
                    } else {
                        throw new Error(`Failed to fetch existing review: ${res.statusText}`);
                    }
                } catch (err: any) {
                    setError(err.message || 'Error fetching review');
                    setReviewId(null);
                    setRevisedScore('');
                    setTeacherFeedback('');
                }
            } else {
                setReviewId(null);
                setRevisedScore('');
                setTeacherFeedback('');
            }
        };

        if (isOpen) {
            fetchReview();
        } else {
            // Reset state when modal closes
            setReviewId(null);
            setRevisedScore('');
            setTeacherFeedback('');
            setError('');
        }
    }, [isOpen, submission]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!submission) return;

        const url = reviewId ? `/api/teacher-reviews/${reviewId}` : '/api/teacher-reviews';
        const method = reviewId ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    submission_id: submission.id,
                    revised_score: Number(revisedScore),
                    teacher_feedback: teacherFeedback,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save review.');
            }
            
            await onFinished();
            onClose();
        } catch (err: any) {
            setError(err.message);
        }
    };

    if (!isOpen) return null;

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Review Submission`}>
            <form onSubmit={handleSubmit} className="space-y-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <div>
                    <label className="block text-sm font-medium">Skor Revisi</label>
                    <input type="number" value={revisedScore} onChange={e => setRevisedScore(e.target.value)} className="sage-input mt-1" required />
                </div>
                <div>
                    <label className="block text-sm font-medium">Umpan Balik Guru</label>
                    <textarea value={teacherFeedback} onChange={e => setTeacherFeedback(e.target.value)} className="sage-input mt-1" rows={4} />
                </div>
                <div className="flex justify-end gap-3 pt-2">
                    <button type="button" onClick={onClose} className="sage-button-outline">Batal</button>
                    <button type="submit" className="sage-button">Simpan Review</button>
                </div>
            </form>
        </Modal>
    );
};

// --- EDIT MATERIAL MODAL ---
interface EditMaterialModalProps {
    isOpen: boolean;
    onClose: () => void;
    material: MaterialDetail;
    onFinished: () => void;
}

const EditMaterialModal = ({ isOpen, onClose, material, onFinished }: EditMaterialModalProps) => {
    const [judul, setJudul] = useState(material.judul);
    const [editorHtml, setEditorHtml] = useState("");
    const [textColor, setTextColor] = useState("#111827");
    const [fontSizePx, setFontSizePx] = useState(16);
    const [showFontSizeMenu, setShowFontSizeMenu] = useState(false);
    const [showTablePicker, setShowTablePicker] = useState(false);
    const [tableHover, setTableHover] = useState({ rows: 0, cols: 0 });
    const [isFocusMode, setIsFocusMode] = useState(false);
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const editorRef = useRef<HTMLDivElement | null>(null);
    const imageInputRef = useRef<HTMLInputElement | null>(null);
    const pdfInputRef = useRef<HTMLInputElement | null>(null);
    const toolbarRef = useRef<HTMLDivElement | null>(null);
    const savedRangeRef = useRef<Range | null>(null);
    const hoveredMediaRef = useRef<HTMLDivElement | null>(null);
    const selectedMediaRef = useRef<HTMLDivElement | null>(null);
    const historyRef = useRef<string[]>([]);
    const redoRef = useRef<string[]>([]);

    const mediaDeleteButtonHtml =
      `<button data-media-delete="1" type="button" style="display:none;position:absolute;top:6px;right:6px;width:24px;height:24px;border:1px solid #fecaca;border-radius:999px;background:#fff;color:#b91c1c;font-weight:700;line-height:1;align-items:center;justify-content:center;cursor:pointer;z-index:5;" title="Hapus media"></button>`;

    useEffect(() => {
        if (!isOpen) return;
        setJudul(material.judul);
        const initialHtml = normalizeMaterialForRichEditor(material.isi_materi, material.file_url);
        setEditorHtml(initialHtml);
        if (editorRef.current) {
          editorRef.current.innerHTML = initialHtml;
          normalizeEditorNodeDirection(editorRef.current);
          ensureMediaBlocksEditableBehavior(editorRef.current);
        }
        historyRef.current = [initialHtml];
        redoRef.current = [];
        setFontSizePx(16);
        setShowFontSizeMenu(false);
        setShowTablePicker(false);
        setIsFocusMode(false);
    }, [material, isOpen]);

    useEffect(() => {
      const handleOutsideClick = (event: MouseEvent) => {
        if (!toolbarRef.current) return;
        if (!toolbarRef.current.contains(event.target as Node)) {
          setShowFontSizeMenu(false);
          setShowTablePicker(false);
        }
      };
      document.addEventListener("mousedown", handleOutsideClick);
      return () => document.removeEventListener("mousedown", handleOutsideClick);
    }, []);

    const pushHistorySnapshot = (html: string) => {
      const normalized = sanitizeEditorHtml(html);
      const history = historyRef.current;
      if (history.length === 0 || history[history.length - 1] !== normalized) {
        history.push(normalized);
        if (history.length > 200) {
          history.shift();
        }
      }
    };

    const showMediaDeleteButton = (media: HTMLDivElement | null, visible: boolean) => {
      if (!media) return;
      const btn = media.querySelector<HTMLElement>("[data-media-delete='1']");
      if (!btn) return;
      btn.style.display = visible ? "inline-flex" : "none";
    };

    const applyMediaSelectedStyle = (media: HTMLDivElement | null, selected: boolean) => {
      if (!media) return;
      media.style.outline = selected ? "2px solid #2563eb" : "none";
      media.style.boxShadow = selected ? "0 0 0 3px rgba(37,99,235,0.15)" : "none";
    };

    const setSelectedMedia = (media: HTMLDivElement | null) => {
      if (selectedMediaRef.current && selectedMediaRef.current !== media) {
        applyMediaSelectedStyle(selectedMediaRef.current, false);
        if (selectedMediaRef.current !== hoveredMediaRef.current) {
          showMediaDeleteButton(selectedMediaRef.current, false);
        }
      }
      selectedMediaRef.current = media;
      if (media) {
        applyMediaSelectedStyle(media, true);
        showMediaDeleteButton(media, true);
      }
    };

    const setHoveredMedia = (media: HTMLDivElement | null) => {
      if (hoveredMediaRef.current && hoveredMediaRef.current !== media && hoveredMediaRef.current !== selectedMediaRef.current) {
        showMediaDeleteButton(hoveredMediaRef.current, false);
      }
      hoveredMediaRef.current = media;
      if (media) {
        showMediaDeleteButton(media, true);
      }
    };

    const ensureMediaBlocksEditableBehavior = (editor: HTMLDivElement | null) => {
      if (!editor) return;
      const mediaBlocks = editor.querySelectorAll<HTMLDivElement>("[data-media-block='1']");
      mediaBlocks.forEach((block) => {
        block.setAttribute("contenteditable", "false");
        block.style.position = "relative";

        let deleteBtn = block.querySelector<HTMLElement>("[data-media-delete='1']");
        if (!deleteBtn) {
          block.insertAdjacentHTML("afterbegin", mediaDeleteButtonHtml);
          deleteBtn = block.querySelector<HTMLElement>("[data-media-delete='1']");
        }
        if (deleteBtn) {
          deleteBtn.style.zIndex = "8";
          deleteBtn.style.pointerEvents = "auto";
        }

        block.querySelectorAll<HTMLElement>("iframe,video,embed,object").forEach((el) => {
          el.style.pointerEvents = "none";
          el.setAttribute("tabindex", "-1");
        });
        block.querySelectorAll<HTMLAnchorElement>("a").forEach((a) => {
          a.style.pointerEvents = "none";
          a.setAttribute("tabindex", "-1");
          a.removeAttribute("target");
        });
      });
    };

    const applyEditorCommand = (command: string, value?: string) => {
        const editor = editorRef.current;
        if (!editor) return;
        editor.focus();
        if (savedRangeRef.current) {
          const selection = window.getSelection();
          if (selection) {
            selection.removeAllRanges();
            selection.addRange(savedRangeRef.current);
          }
        }
        if (command === "formatBlock" && value) {
          document.execCommand("formatBlock", false, `<${value.toLowerCase()}>`);
        } else {
          document.execCommand(command, false, value);
        }
        normalizeEditorNodeDirection(editor);
        const selection = window.getSelection();
        if (selection && selection.rangeCount > 0) {
          savedRangeRef.current = selection.getRangeAt(0).cloneRange();
        }
        setEditorHtml(editor.innerHTML);
        pushHistorySnapshot(editor.innerHTML);
        redoRef.current = [];
    };

    const handleAddLink = () => {
        const url = window.prompt("Masukkan URL link:");
        if (!url) return;
        const trimmed = url.trim();
        const youtubeMatch = trimmed.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&?/]+)/i) || trimmed.match(/youtube\.com\/shorts\/([^&?/]+)/i);
        if (youtubeMatch?.[1]) {
          const embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}`;
          applyEditorCommand(
            "insertHTML",
            `<p><br/></p><div data-media-block="1" contenteditable="false" style="position:relative;resize:both;overflow:auto;width:560px;max-width:100%;min-height:260px;border:1px dashed #cbd5e1;border-radius:10px;padding:6px;margin:8px auto 8px 0;background:#f8fafc;">
              ${mediaDeleteButtonHtml}
              <iframe src="${embedUrl}" title="Embedded YouTube" style="width:100%;height:100%;min-height:240px;border:0;border-radius:8px;pointer-events:none;" allowfullscreen></iframe>
              <div style="position:absolute;right:8px;bottom:6px;font-size:11px;color:#64748b;pointer-events:none;"> drag</div>
            </div><p><br/></p>`
          );
          return;
        }
        const editor = editorRef.current;
        if (!editor) return;
        const selection = window.getSelection();
        if (selection && !selection.isCollapsed) {
          applyEditorCommand("createLink", trimmed);
          return;
        }
        applyEditorCommand("insertHTML", `<a href="${escapeHtml(trimmed)}" target="_blank" rel="noopener noreferrer">${escapeHtml(trimmed)}</a>`);
    };

    const handleInsertImageByUrl = () => {
      const url = window.prompt("Masukkan URL gambar:");
      if (!url) return;
      const safe = escapeHtml(url.trim());
      applyEditorCommand(
        "insertHTML",
        `<p><br/></p><div data-media-block="1" contenteditable="false" style="position:relative;resize:both;overflow:auto;width:420px;max-width:100%;border:1px dashed #cbd5e1;border-radius:10px;padding:6px;margin:8px auto 8px 0;">
          ${mediaDeleteButtonHtml}
          <img src="${safe}" alt="Gambar materi" style="width:100%;height:auto;display:block;border-radius:8px;" />
          <div style="position:absolute;right:8px;bottom:6px;font-size:11px;color:#64748b;pointer-events:none;"> drag</div>
        </div><p><br/></p>`
      );
    };

    const handleUploadImage = async (file: File | null) => {
      if (!file) return;
      setError("");
      if (file.size > 1024 * 1024) {
        setError("Ukuran gambar maksimal 1MB.");
        return;
      }
      if (!file.type.startsWith("image/")) {
        setError("File harus berupa gambar.");
        return;
      }
      try {
        const formData = new FormData();
        formData.append("file", file);
        const response = await fetch("/api/upload", {
          method: "POST",
          credentials: "include",
          body: formData,
        });
        const body = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(body?.message || "Gagal upload gambar.");
        }
        if (!body?.filePath) {
          throw new Error("Respons upload gambar tidak valid.");
        }
        const safePath = escapeHtml(body.filePath);
        applyEditorCommand(
          "insertHTML",
          `<p><br/></p><div data-media-block="1" contenteditable="false" style="position:relative;resize:both;overflow:auto;width:420px;max-width:100%;border:1px dashed #cbd5e1;border-radius:10px;padding:6px;margin:8px auto 8px 0;">
            ${mediaDeleteButtonHtml}
            <img src="${safePath}" alt="Gambar materi" style="width:100%;height:auto;display:block;border-radius:8px;" />
            <div style="position:absolute;right:8px;bottom:6px;font-size:11px;color:#64748b;pointer-events:none;"> drag</div>
          </div><p><br/></p>`
        );
      } catch (err: any) {
        setError(err?.message || "Gagal upload gambar.");
      }
    };

    const handleUploadPdf = async (file: File | null) => {
      if (!file) return;
      setError("");
      const isPdf = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
      if (!isPdf) {
        setError("File harus berformat PDF.");
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        setError("Ukuran PDF maksimal 5MB.");
        return;
      }
      try {
        const formData = new FormData();
        formData.append("file", file);
        const response = await fetch("/api/upload", {
          method: "POST",
          credentials: "include",
          body: formData,
        });
        const body = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(body?.message || "Gagal upload PDF.");
        if (!body?.filePath) throw new Error("Respons upload PDF tidak valid.");
        const safePath = escapeHtml(body.filePath);
        applyEditorCommand(
          "insertHTML",
          `<p><br/></p><div data-media-block="1" contenteditable="false" style="position:relative;resize:both;overflow:auto;width:520px;max-width:100%;min-height:220px;border:1px dashed #cbd5e1;border-radius:10px;padding:6px;margin:8px auto 8px 0;background:#f8fafc;">
            ${mediaDeleteButtonHtml}
            <iframe src="${safePath}" title="PDF Materi" style="width:100%;height:100%;min-height:200px;border:0;border-radius:8px;pointer-events:none;"></iframe>
            <div style="margin-top:6px;font-size:12px;color:#475569;">Preview PDF (non-interaktif saat mode edit)</div>
            <div style="position:absolute;right:8px;bottom:6px;font-size:11px;color:#64748b;pointer-events:none;"> drag</div>
          </div><p><br/></p>`
        );
      } catch (err: any) {
        setError(err?.message || "Gagal upload PDF.");
      }
    };

    const getSelectedMediaBlock = () => {
      const editor = editorRef.current;
      const selection = window.getSelection();
      if (!editor || !selection || selection.rangeCount === 0) return null;
      const range = selection.getRangeAt(0);
      const node = range.commonAncestorContainer;
      const host = node.nodeType === Node.TEXT_NODE ? node.parentElement : (node as HTMLElement | null);
      const media = host?.closest("[data-media-block='1']") as HTMLDivElement | null;
      if (!media || !editor.contains(media)) return null;
      return { editor, media };
    };

    const alignSelectedMedia = (position: "left" | "center" | "right") => {
      const selected = selectedMediaRef.current;
      const editor = editorRef.current;
      if (!selected || !editor || !editor.contains(selected)) return;
      if (position === "left") {
        selected.style.marginLeft = "0";
        selected.style.marginRight = "auto";
      } else if (position === "center") {
        selected.style.marginLeft = "auto";
        selected.style.marginRight = "auto";
      } else {
        selected.style.marginLeft = "auto";
        selected.style.marginRight = "0";
      }
      setEditorHtml(editor.innerHTML);
      pushHistorySnapshot(editor.innerHTML);
      redoRef.current = [];
    };

    const removeSelectedMediaBlock = () => {
      const editor = editorRef.current;
      const media = selectedMediaRef.current;
      if (!editor || !media || !editor.contains(media)) return;
      const prev = media.previousElementSibling as HTMLElement | null;
      const next = media.nextElementSibling as HTMLElement | null;
      media.remove();
      if (prev && prev.tagName === "P" && (prev.textContent || "").trim() === "") prev.remove();
      if (next && next.tagName === "P" && (next.textContent || "").trim() === "") next.remove();
      setSelectedMedia(null);
      setHoveredMedia(null);
      setEditorHtml(editor.innerHTML);
      pushHistorySnapshot(editor.innerHTML);
      redoRef.current = [];
    };

    const insertTableAtSelection = (rows: number, cols: number) => {
      if (!Number.isInteger(rows) || !Number.isInteger(cols) || rows <= 0 || cols <= 0 || rows > 20 || cols > 10) {
        setError("Ukuran tabel tidak valid. Maksimal 20x10.");
        return;
      }

      const headerCells = Array.from({ length: cols }, (_, i) => `<th style="border:1px solid #cbd5e1;padding:8px;background:#f8fafc;">Kolom ${i + 1}</th>`).join("");
      const bodyRows = Array.from({ length: rows - 1 }, () =>
        `<tr>${Array.from({ length: cols }, () => `<td style="border:1px solid #cbd5e1;padding:8px;">&nbsp;</td>`).join("")}</tr>`
      ).join("");
      const tableHtml = `<div style="position:relative;resize:both;overflow:auto;width:100%;max-width:100%;border:1px dashed #cbd5e1;border-radius:10px;padding:6px;margin:8px 0;background:#fff;">
        <table style="border-collapse:collapse;width:100%;margin:0;"><thead><tr>${headerCells}</tr></thead><tbody>${bodyRows}</tbody></table>
        <div style="position:absolute;right:8px;bottom:6px;font-size:11px;color:#64748b;pointer-events:none;"> drag</div>
      </div><p></p>`;
      applyEditorCommand("insertHTML", tableHtml);
      setShowTablePicker(false);
      setTableHover({ rows: 0, cols: 0 });
    };

    const getTableContext = () => {
      const editor = editorRef.current;
      const selection = window.getSelection();
      if (!editor || !selection || selection.rangeCount === 0) return null;
      const range = selection.getRangeAt(0);
      const node = range.commonAncestorContainer;
      const host = node.nodeType === Node.TEXT_NODE ? node.parentElement : (node as HTMLElement | null);
      const cell = host?.closest("td,th") as HTMLTableCellElement | null;
      const table = host?.closest("table") as HTMLTableElement | null;
      if (!cell || !table || !editor.contains(table)) return null;
      const row = cell.parentElement as HTMLTableRowElement | null;
      if (!row) return null;
      return {
        editor,
        table,
        cell,
        row,
        rowIndex: row.rowIndex,
        cellIndex: cell.cellIndex,
      };
    };

    const handleDeleteCurrentTable = () => {
      const ctx = getTableContext();
      if (!ctx) return;
      ctx.table.remove();
      normalizeEditorNodeDirection(ctx.editor);
      setEditorHtml(ctx.editor.innerHTML);
      pushHistorySnapshot(ctx.editor.innerHTML);
      redoRef.current = [];
    };

    const handleAddTableRow = () => {
      const ctx = getTableContext();
      if (!ctx) return;
      const colCount = ctx.row.cells.length || 1;
      const newRow = ctx.table.insertRow(ctx.rowIndex + 1);
      for (let i = 0; i < colCount; i++) {
        const td = newRow.insertCell();
        td.style.border = "1px solid #cbd5e1";
        td.style.padding = "8px";
        td.innerHTML = "&nbsp;";
      }
      setEditorHtml(ctx.editor.innerHTML);
      pushHistorySnapshot(ctx.editor.innerHTML);
      redoRef.current = [];
    };

    const handleDeleteTableRow = () => {
      const ctx = getTableContext();
      if (!ctx) return;
      if (ctx.table.rows.length <= 1) {
        ctx.table.remove();
      } else {
        ctx.table.deleteRow(ctx.rowIndex);
      }
      setEditorHtml(ctx.editor.innerHTML);
      pushHistorySnapshot(ctx.editor.innerHTML);
      redoRef.current = [];
    };

    const handleAddTableColumn = () => {
      const ctx = getTableContext();
      if (!ctx) return;
      Array.from(ctx.table.rows).forEach((r) => {
        const isHeaderRow = (r.parentElement?.tagName || "").toLowerCase() === "thead" || Array.from(r.cells).some((c) => c.tagName.toLowerCase() === "th");
        const cell = document.createElement(isHeaderRow ? "th" : "td");
        cell.style.border = "1px solid #cbd5e1";
        cell.style.padding = "8px";
        cell.innerHTML = isHeaderRow ? "Kolom Baru" : "&nbsp;";
        if (ctx.cellIndex + 1 >= r.cells.length) {
          r.appendChild(cell);
        } else {
          r.insertBefore(cell, r.cells[ctx.cellIndex + 1]);
        }
      });
      setEditorHtml(ctx.editor.innerHTML);
      pushHistorySnapshot(ctx.editor.innerHTML);
      redoRef.current = [];
    };

    const handleDeleteTableColumn = () => {
      const ctx = getTableContext();
      if (!ctx) return;
      const colCount = ctx.row.cells.length;
      if (colCount <= 1) {
        ctx.table.remove();
      } else {
        Array.from(ctx.table.rows).forEach((r) => {
          if (ctx.cellIndex < r.cells.length) {
            r.deleteCell(ctx.cellIndex);
          }
        });
      }
      setEditorHtml(ctx.editor.innerHTML);
      pushHistorySnapshot(ctx.editor.innerHTML);
      redoRef.current = [];
    };

    const applyFontSize = (sizePx: number) => {
      const editor = editorRef.current;
      if (!editor) return;
      editor.focus();
      if (savedRangeRef.current) {
        const selection = window.getSelection();
        if (selection) {
          selection.removeAllRanges();
          selection.addRange(savedRangeRef.current);
        }
      }
      document.execCommand("styleWithCSS", false, "true");
      document.execCommand("fontSize", false, "7");
      editor.querySelectorAll("font[size='7']").forEach((fontNode) => {
        const span = document.createElement("span");
        span.style.fontSize = `${sizePx}px`;
        span.innerHTML = fontNode.innerHTML;
        fontNode.replaceWith(span);
      });
      normalizeEditorNodeDirection(editor);
      const selection = window.getSelection();
      if (selection && selection.rangeCount > 0) {
        savedRangeRef.current = selection.getRangeAt(0).cloneRange();
      }
      setEditorHtml(editor.innerHTML);
      pushHistorySnapshot(editor.innerHTML);
      redoRef.current = [];
    };

    const handleUndo = () => {
      const editor = editorRef.current;
      if (!editor) return;
      const history = historyRef.current;
      if (history.length <= 1) return;
      const current = history.pop();
      if (current) {
        redoRef.current.push(current);
      }
      const previous = history[history.length - 1] || "<p></p>";
      editor.innerHTML = previous;
      normalizeEditorNodeDirection(editor);
      setEditorHtml(previous);
    };

    const handleRedo = () => {
      const editor = editorRef.current;
      if (!editor) return;
      const next = redoRef.current.pop();
      if (!next) return;
      editor.innerHTML = next;
      normalizeEditorNodeDirection(editor);
      setEditorHtml(next);
      pushHistorySnapshot(next);
    };

    const updateSelectionRange = () => {
      const editor = editorRef.current;
      if (!editor) return;
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return;
      const range = selection.getRangeAt(0);
      const common = range.commonAncestorContainer;
      if (editor.contains(common.nodeType === Node.TEXT_NODE ? common.parentNode : common)) {
        savedRangeRef.current = range.cloneRange();
      }
    };

    const runToolbarAction = (action: () => void) => (e: React.MouseEvent<HTMLButtonElement>) => {
      e.preventDefault();
      action();
    };

    const toolbarButtonClass = "sage-button-outline !px-2 !py-1 text-xs";
    const toolbarButtons: Array<{
      key: string;
      label: string;
      tooltip: string;
      action: () => void;
      className?: string;
    }> = [
      { key: "bold", label: "B", tooltip: "Bold: menebalkan teks terpilih.", action: () => applyEditorCommand("bold"), className: "font-bold" },
      { key: "italic", label: "I", tooltip: "Italic: memiringkan teks terpilih.", action: () => applyEditorCommand("italic"), className: "italic" },
      { key: "underline", label: "U", tooltip: "Underline: memberi garis bawah pada teks terpilih.", action: () => applyEditorCommand("underline"), className: "underline" },
      { key: "unlink", label: "Unlink", tooltip: "Unlink: hapus tautan dari teks terpilih.", action: () => applyEditorCommand("unlink") },
      { key: "clear", label: "Clear", tooltip: "Clear Format: hapus format dan kembali ke teks biasa.", action: () => applyEditorCommand("removeFormat") },
    ];

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        const formData = new FormData();
        formData.append('judul', judul);

        const htmlFromEditor = sanitizeEditorHtml(editorRef.current?.innerHTML || editorHtml);
        const plainText = htmlFromEditor.replace(/<[^>]+>/g, "").trim();
        if (!plainText) {
            setError('Isi materi tidak boleh kosong.');
            setLoading(false);
            return;
        }
        formData.append('isiMateri', htmlFromEditor);
        formData.append('clearFile', 'true');

        try {
            const response = await fetch(`/api/materials/${material.id}`, {
                method: 'PUT',
                credentials: 'include',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Gagal memperbarui materi.');
            }

            onFinished();
            onClose();

        } catch (err: any) {
            setError(err.message || 'Gagal menghubungi server.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <Modal
            isOpen={isOpen}
            onClose={onClose}
            title="Edit Materi"
            panelClassName="max-w-[96vw] md:max-w-[95vw] xl:max-w-[92vw] h-[92vh] overflow-hidden"
        >
            <form onSubmit={handleSubmit} className="h-full flex flex-col gap-4">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                {!isFocusMode && (
                <div>
                    <label className="block text-sm font-medium">Judul Materi</label>
                    <input type="text" value={judul} onChange={e => setJudul(e.target.value)} className="sage-input mt-1" required />
                </div>
                )}
                <div className={`flex-1 min-h-0 grid gap-4 ${isFocusMode ? "grid-cols-1" : "lg:grid-cols-[1.25fr_1fr]"}`}>
                    <div className="min-h-0 overflow-y-auto pr-1 space-y-3">
                        <label className="block text-sm font-medium">Isi Materi (Rich Text)</label>
                        <div className="rounded-lg border border-slate-200 bg-white">
                            <div ref={toolbarRef} className="flex flex-wrap items-center justify-between gap-3 border-b border-slate-200 p-2">
                                <div className="flex flex-wrap items-center gap-2">
                                  <p className="text-[11px] font-semibold uppercase tracking-wide text-slate-500 mr-1">Format</p>
                                {toolbarButtons.map((btn) => (
                                  <button
                                    key={btn.key}
                                    type="button"
                                    title={btn.tooltip}
                                    aria-label={btn.tooltip}
                                    className={`${toolbarButtonClass} ${btn.className || ""}`.trim()}
                                    onMouseDown={runToolbarAction(btn.action)}
                                  >
                                    {btn.label}
                                  </button>
                                ))}
                                </div>
                                <label className="inline-flex items-center gap-2 text-xs text-slate-600 ml-1" title="Text Color: ubah warna teks terpilih.">
                                  <span>Color</span>
                                  <input
                                    type="color"
                                    value={textColor}
                                    onChange={(e) => {
                                      const next = e.target.value;
                                      setTextColor(next);
                                      applyEditorCommand("foreColor", next);
                                    }}
                                    className="h-7 w-9 cursor-pointer rounded border border-slate-300 bg-white p-0.5"
                                    aria-label="Text Color: ubah warna teks terpilih"
                                  />
                                </label>
                                <div className="relative">
                                  <button
                                    type="button"
                                    title="Ukuran Font: pilih ukuran teks terpilih."
                                    aria-label="Ukuran Font: pilih ukuran teks terpilih"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                      setShowFontSizeMenu((prev) => !prev);
                                      setShowTablePicker(false);
                                    }}
                                  >
                                    <FiType size={14} /> {fontSizePx}px
                                  </button>
                                  {showFontSizeMenu && (
                                    <div className="absolute right-0 top-9 z-20 w-28 rounded-lg border border-slate-200 bg-white p-2 shadow-lg">
                                      {[12, 14, 16, 18, 20, 24, 28, 32].map((size) => (
                                        <button
                                          key={size}
                                          type="button"
                                          className={`w-full rounded-md px-2 py-1 text-left text-xs hover:bg-slate-100 ${fontSizePx === size ? "bg-slate-100 font-semibold" : ""}`}
                                          onMouseDown={(e) => {
                                            e.preventDefault();
                                            setFontSizePx(size);
                                            applyFontSize(size);
                                            setShowFontSizeMenu(false);
                                          }}
                                        >
                                          {size}px
                                        </button>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-2">
                                  <p className="text-[11px] font-semibold uppercase tracking-wide text-slate-500 mr-1">Sisipkan</p>
                                  <button
                                    type="button"
                                    title="Sisipkan Link / Embed: jika YouTube akan otomatis embed."
                                    aria-label="Sisipkan Link atau Embed YouTube"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    onMouseDown={runToolbarAction(handleAddLink)}
                                  >
                                    <FiLink size={14} /> Link
                                  </button>
                                  <button
                                    type="button"
                                    title="Sisipkan Gambar URL: menambahkan gambar dari URL."
                                    aria-label="Sisipkan Gambar URL: menambahkan gambar dari URL"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    onMouseDown={runToolbarAction(handleInsertImageByUrl)}
                                  >
                                    <FiImage size={14} /> URL
                                  </button>
                                  <button
                                    type="button"
                                    title="Upload Gambar: unggah file gambar (maksimal 1MB)."
                                    aria-label="Upload Gambar: unggah file gambar maksimal 1MB"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                      imageInputRef.current?.click();
                                    }}
                                  >
                                    <FiUploadCloud size={14} /> Upload
                                  </button>
                                  <input
                                    ref={imageInputRef}
                                    type="file"
                                    accept="image/*"
                                    className="hidden"
                                    onChange={(e) => {
                                      const file = e.target.files?.[0] || null;
                                      handleUploadImage(file);
                                      e.currentTarget.value = "";
                                    }}
                                  />
                                  <button
                                    type="button"
                                    title="Sisipkan PDF: upload file PDF maksimal 5MB."
                                    aria-label="Sisipkan PDF maksimal 5MB"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                      pdfInputRef.current?.click();
                                    }}
                                  >
                                    <FiFileText size={14} /> PDF
                                  </button>
                                  <input
                                    ref={pdfInputRef}
                                    type="file"
                                    accept=".pdf,application/pdf"
                                    className="hidden"
                                    onChange={(e) => {
                                      const file = e.target.files?.[0] || null;
                                      handleUploadPdf(file);
                                      e.currentTarget.value = "";
                                    }}
                                  />
                                  <div className="relative">
                                    <button
                                      type="button"
                                      title="Insert Table: pilih ukuran tabel secara interaktif."
                                      aria-label="Insert Table: pilih ukuran tabel secara interaktif"
                                      className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                      onMouseDown={(e) => {
                                        e.preventDefault();
                                        setShowTablePicker((prev) => !prev);
                                        setShowFontSizeMenu(false);
                                      }}
                                    >
                                      <FiGrid size={14} /> Table
                                    </button>
                                    {showTablePicker && (
                                      <div className="absolute right-0 top-9 z-20 w-[320px] rounded-lg border border-slate-200 bg-white p-3 shadow-lg">
                                        <div className="grid grid-cols-8 gap-2">
                                          {Array.from({ length: 64 }, (_, idx) => {
                                            const r = Math.floor(idx / 8) + 1;
                                            const c = (idx % 8) + 1;
                                            const active = r <= tableHover.rows && c <= tableHover.cols;
                                            return (
                                              <button
                                                key={`${r}-${c}`}
                                                type="button"
                                                className={`h-7 w-7 rounded-[4px] border ${active ? "border-slate-700 bg-slate-700" : "border-slate-300 bg-white"}`}
                                                onMouseEnter={() => setTableHover({ rows: r, cols: c })}
                                                onMouseDown={(e) => {
                                                  e.preventDefault();
                                                  insertTableAtSelection(r, c);
                                                }}
                                                aria-label={`Insert table ${r}x${c}`}
                                                title={`Insert table ${r}x${c}`}
                                              />
                                            );
                                          })}
                                        </div>
                                        <p className="mt-2 text-xs text-slate-600 text-center">{tableHover.rows || 0} x {tableHover.cols || 0}</p>
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-2">
                                  <p className="text-[11px] font-semibold uppercase tracking-wide text-slate-500 mr-1">Tabel</p>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1" title="Tambah Baris: tambah baris di bawah sel aktif." onMouseDown={runToolbarAction(handleAddTableRow)}><FiPlusSquare size={14} /> Baris</button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1" title="Hapus Baris: hapus baris aktif." onMouseDown={runToolbarAction(handleDeleteTableRow)}><FiMinusSquare size={14} /> Baris</button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1" title="Tambah Kolom: tambah kolom di kanan sel aktif." onMouseDown={runToolbarAction(handleAddTableColumn)}><FiPlusSquare size={14} /> Kolom</button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1" title="Hapus Kolom: hapus kolom aktif." onMouseDown={runToolbarAction(handleDeleteTableColumn)}><FiMinusSquare size={14} /> Kolom</button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1 text-red-700 border-red-200 hover:bg-red-50" title="Hapus Tabel: hapus seluruh tabel aktif." onMouseDown={runToolbarAction(handleDeleteCurrentTable)}><FiTrash2 size={14} /> Tabel</button>
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-1">
                                  <p className="text-[11px] font-semibold uppercase tracking-wide text-slate-500 mr-1">Paragraf</p>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata Kiri" onMouseDown={runToolbarAction(() => applyEditorCommand("justifyLeft"))}><FiAlignLeft size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata Tengah" onMouseDown={runToolbarAction(() => applyEditorCommand("justifyCenter"))}><FiAlignCenter size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata Kanan" onMouseDown={runToolbarAction(() => applyEditorCommand("justifyRight"))}><FiAlignRight size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Justify" onMouseDown={runToolbarAction(() => applyEditorCommand("justifyFull"))}><FiAlignJustify size={14} /></button>
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-1">
                                  <p className="text-[11px] font-semibold uppercase tracking-wide text-slate-500 mr-1">Media</p>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata kiri untuk media terpilih" onMouseDown={runToolbarAction(() => alignSelectedMedia("left"))}><FiAlignLeft size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata tengah untuk media terpilih" onMouseDown={runToolbarAction(() => alignSelectedMedia("center"))}><FiAlignCenter size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Rata kanan untuk media terpilih" onMouseDown={runToolbarAction(() => alignSelectedMedia("right"))}><FiAlignRight size={14} /></button>
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-1">
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Undo" onMouseDown={runToolbarAction(handleUndo)}><FiRotateCcw size={14} /></button>
                                  <button type="button" className="sage-button-outline !px-2 !py-1 text-xs" title="Redo" onMouseDown={runToolbarAction(handleRedo)}><FiRotateCw size={14} /></button>
                                </div>
                                <div className="h-5 w-px bg-slate-200" />
                                <div className="flex flex-wrap items-center gap-1">
                                  <button
                                    type="button"
                                    className="sage-button-outline !px-2 !py-1 text-xs inline-flex items-center gap-1"
                                    title={isFocusMode ? "Keluar Full Screen Editor" : "Masuk Full Screen Editor"}
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                      setIsFocusMode((prev) => !prev);
                                    }}
                                  >
                                    {isFocusMode ? <FiMinimize2 size={14} /> : <FiMaximize2 size={14} />}
                                  </button>
                                </div>
                            </div>
                            <div
                                ref={editorRef}
                                contentEditable
                                dir="ltr"
                                suppressContentEditableWarning
                                onMouseUp={updateSelectionRange}
                                onKeyUp={updateSelectionRange}
                                onFocus={updateSelectionRange}
                                onKeyDown={(e) => {
                                  if ((e.key === "Delete" || e.key === "Backspace") && selectedMediaRef.current) {
                                    e.preventDefault();
                                    removeSelectedMediaBlock();
                                    return;
                                  }
                                }}
                                onMouseMove={(e) => {
                                  const target = e.target as HTMLElement;
                                  const media = target.closest("[data-media-block='1']") as HTMLDivElement | null;
                                  setHoveredMedia(media);
                                }}
                                onMouseLeave={() => {
                                  if (hoveredMediaRef.current && hoveredMediaRef.current !== selectedMediaRef.current) {
                                    showMediaDeleteButton(hoveredMediaRef.current, false);
                                  }
                                  hoveredMediaRef.current = null;
                                }}
                                onClick={(e) => {
                                  const target = e.target as HTMLElement;
                                  const editor = editorRef.current;
                                  if (!editor) return;
                                  const deleteBtn = target.closest("[data-media-delete='1']") as HTMLElement | null;
                                  if (deleteBtn) {
                                    const media = deleteBtn.closest("[data-media-block='1']") as HTMLDivElement | null;
                                    if (media && editor.contains(media)) {
                                      setSelectedMedia(media);
                                      removeSelectedMediaBlock();
                                    }
                                    return;
                                  }
                                  const media = target.closest("[data-media-block='1']") as HTMLDivElement | null;
                                  if (media && editor.contains(media)) {
                                    setSelectedMedia(media);
                                    return;
                                  }
                                  setSelectedMedia(null);
                                }}
                                onInput={(e) => {
                                  const node = e.currentTarget as HTMLDivElement;
                                  normalizeEditorNodeDirection(node);
                                  ensureMediaBlocksEditableBehavior(node);
                                  updateSelectionRange();
                                  setEditorHtml(node.innerHTML);
                                  pushHistorySnapshot(node.innerHTML);
                                  redoRef.current = [];
                                }}
                                className="min-h-[380px] max-h-[58vh] overflow-y-auto p-4 outline-none leading-relaxed text-left"
                                style={{ direction: "ltr", unicodeBidi: "normal", writingMode: "horizontal-tb", textAlign: "left" }}
                            />
                        </div>
                    </div>
                    {!isFocusMode && <div className="hidden lg:block">
                        <div className="sticky top-0 border rounded-lg p-3 bg-white max-h-[64vh] overflow-y-auto">
                            <p className="text-sm font-medium text-slate-700 mb-2">Preview</p>
                            <div className="prose prose-slate max-w-none text-sm" dangerouslySetInnerHTML={{ __html: sanitizeEditorHtml(editorHtml) }} />
                        </div>
                    </div>}
                </div>
                <div className="flex justify-end gap-3 pt-2 border-t border-slate-100 mt-auto">
                    <button type="button" onClick={onClose} className="py-2 px-4 bg-[color:var(--sand-100)] rounded-md">Batal</button>
                    <button type="submit" disabled={loading} className="py-2 px-4 bg-[color:var(--sage-700)] text-white rounded-md">{loading ? 'Menyimpan...' : 'Simpan Perubahan'}</button>
                </div>
            </form>
            <LoadingDialog isOpen={loading} message="Menyimpan perubahan materi..." />
        </Modal>
    );
};
